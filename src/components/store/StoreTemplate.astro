---
const {
  store = {},
  theme = {},
  products = [],
  isPreview = false,
  layout = 'natural', 
  font = 'classic'
} = Astro.props;

// 1. Safe Defaults
const safeStore = {
  name: store.name || 'Your Store Name',
  tagline: store.tagline || 'A short soulful tagline',
  about: store.about || 'Tell customers about your craft, your journey, and what makes you special.',
  logo: store.logo || null,
  address: store.address || null,
  email: store.contact_email,
  whatsapp: store.whatsapp_number,
};

// 2. Color Mapping
const colorStyles = {
  '--theme-brand': theme.primary || '#5b3a1e',
  '--theme-accent': theme.secondary || '#c46a2b',
  '--theme-page': theme.background || '#fffaf0',
  '--theme-ink': theme.text || '#1f1f1f',
  '--theme-header-bg': theme.header || theme.background || '#fffaf0',
};

// 3. Categories (Mock)
const categories = ['All', 'Cakes', 'Breads', 'Cookies', 'Hampers'];

// 4. Products
const displayProducts = products.length > 0 ? products : [
  { 
    id: 1, 
    name: 'Rustic Sourdough', 
    price: 12.00, 
    image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQE9r-lTbqJKsW1nwiQTdVftDfHtIbyqbzyPQ&s',
    description: 'Crispy crust with a chewy, airy interior.',
    full_details: 'Our signature loaf, fermented for 48 hours using wild yeast.',
    product_notice: null,
    accepts_custom_note: false
  },
  { 
    id: 2, 
    name: 'Rosemary Focaccia', 
    price: 14.00, 
    image: 'https://howtofeedaloon.com/wp-content/uploads/2025/04/Focaccia-wtih-Rosemary-and-Olive-Oil-IG.jpg',
    description: 'Infused with fresh rosemary and sea salt.',
    full_details: 'Baked in olive oil for that perfect golden crunch.',
    product_notice: 'Best eaten within 24 hours',
    accepts_custom_note: false
  },
  { 
    id: 3, 
    name: 'Celebration Cake', 
    price: 45.00, 
    image: 'https://images.unsplash.com/photo-1578985545062-69928b1d9587?q=80&w=800&auto=format&fit=crop',
    description: 'Vanilla bean sponge with berry compote.',
    full_details: 'A delicate sponge cake layered with fresh seasonal berries.',
    product_notice: 'Requires 48hr advance notice',
    accepts_custom_note: true 
  }
];
---

<div
  class="store-template-wrapper"
  data-preview={isPreview}
  style={colorStyles}
  data-font-preset={font} 
  data-layout={layout}
  data-products={JSON.stringify(displayProducts)}
>
  <header class="store-header">
    <div class="store-header-inner">
      <div class="header-brand-row">
        <div class="brand-logo-container">
            {safeStore.logo ? (
              <img src={safeStore.logo} class="store-template-logo store-logo-img" alt={safeStore.name} />
            ) : (
              <div class="store-logo-initial store-logo-img">
                {safeStore.name.charAt(0).toUpperCase()}
              </div>
            )}
            <img class="store-template-logo store-logo-img" style="display:none" alt="Logo" />
        </div>
        <h1 class="store-name store-template-name">{safeStore.name}</h1>
      </div>

      <div class="header-nav-row">
        <button class="mobile-menu-btn" aria-label="Menu">
          <span class="material-symbols-rounded">menu</span>
        </button>

        <nav class="header-nav desktop-nav">
          <a href="#about" class="nav-link">About Us</a>
          <a href="#shop" class="nav-link">Shop</a>
          <a href="#contact" class="nav-link">Contact</a>
        </nav>

        <div class="header-actions">
          <button class="icon-btn search-btn" aria-label="Search">
            <span class="material-symbols-rounded">search</span>
          </button>
          <button class="icon-btn cart-btn" aria-label="Cart">
            <span class="material-symbols-rounded">shopping_bag</span>
            <span class="cart-count">0</span>
          </button>
        </div>
      </div>

      <div class="mobile-menu-overlay">
        <div class="mobile-menu-container">
          <button class="mobile-close-btn">
            <span class="material-symbols-rounded">close</span>
          </button>
          <div class="mobile-links">
            <a href="#about" class="nav-link mobile-link">About Us</a>
            <a href="#shop" class="nav-link mobile-link">Shop</a>
            <a href="#contact" class="nav-link mobile-link">Contact</a>
          </div>
        </div>
      </div>
  </header>

  <section class="store-hero", id="about">
    <h2 class="store-tagline store-template-tagline">{safeStore.tagline}</h2>
    <div class="store-about-preview">
      <p class="store-template-about">{safeStore.about}</p>
    </div>
  </section>

  <div class="category-bar-wrapper">
    <div class="category-scroll">
        {categories.map((cat, index) => (
            <button class={`category-pill ${index === 0 ? 'active' : ''}`}>{cat}</button>
        ))}
    </div>
  </div>

  <section class="store-products" id="shop">
    <div class="products-grid">
      {displayProducts.map((product) => (
        <div 
          class="product-card group" 
          data-product={JSON.stringify(product)}
          data-id={product.id} 
        >
          <div class="product-image">
            <img src={product.image} alt={product.name} loading="lazy" />
            <div class="card-badges">
                {product.accepts_custom_note && <span class="badge icon-badge" title="Customizable">✎</span>}
                {product.product_notice && <span class="badge icon-badge" title="Has Notice">!</span>}
            </div>
          </div>

          <div class="product-content">
              <h4 class="product-name">{product.name}</h4>
              <p class="product-short-desc">{product.description}</p>
              <div class="product-footer">
                <span class="product-price">${Number(product.price).toFixed(2)}</span>
              </div>

              <div class="add-action-wrapper" onclick="event.stopPropagation()">
                  <button class="big-add-btn">ADD TO CART</button>
                  <div class="stepper-controls" style="display: none;">
                    <button class="step-btn minus"><span class="material-symbols-rounded">remove</span></button>
                    <span class="qty-display">1</span>
                    <button class="step-btn plus"><span class="material-symbols-rounded">add</span></button>
                  </div>
              </div>
          </div>
        </div>
      ))}
    </div>
  </section>

  <footer class="store-footer" id="contact">
    <div class="footer-container">
      <div class="footer-col brand-col">
      <div class="footer-logo-container">
        </div>
      <h4 class="store-template-name footer-brand-name">{safeStore.name}</h4>
      
      <div 
        class="contact-link footer-address-link" 
        style={safeStore.address ? 'display: flex; margin-top: 1rem;' : 'display: none'}
      >
        <span class="material-symbols-rounded text-sm">location_on</span>
        <span class="footer-address-text">{safeStore.address}</span>
      </div>

    </div>

      <div class="footer-col contact-col">
        <h5>CONTACT ME</h5>
        <a href={`mailto:${safeStore.email}`} class="contact-link footer-email-link" style={safeStore.email ? 'display: flex' : 'display: none'}>
            <span class="material-symbols-rounded text-sm">mail</span> <span class="footer-email-text">{safeStore.email}</span>
        </a>
        <a href="#" class="contact-link footer-whatsapp-link" target="_blank" style={safeStore.whatsapp ? 'display: flex' : 'display: none'}>
            <span class="material-symbols-rounded text-sm">call</span> <span class="footer-whatsapp-text">{safeStore.whatsapp}</span>
        </a>
      </div>

      <div class="footer-col social-col">
        <h5>FOLLOW US</h5>
        <div class="social-icons">
            <a href="#" class="social-link footer-insta-link" target="_blank" style="display: flex">
                <span class="material-symbols-rounded text-sm">photo_camera</span> <span>Instagram</span>
            </a>
            <a href="#" class="social-link footer-fb-link" target="_blank" style="display: flex">
                <span class="material-symbols-rounded text-sm">public</span> <span>Facebook</span>
            </a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      © {new Date().getFullYear()} <span class="store-template-name">{safeStore.name}</span>. Powered by Panchasara.
    </div>
  </footer>

  <dialog id="product-modal" class="product-modal">
  <div class="modal-content">
    <button class="modal-close-btn"><span class="material-symbols-rounded">close</span></button>
    
    <div class="modal-body">
      <div class="modal-img-wrapper">
        <img id="modal-img" src="" alt="">
      </div>
      <div class="modal-info">
        <h3 id="modal-title">Product Name</h3>
        <p id="modal-price">₹0.00</p>
        <p id="modal-desc">Description...</p>

        <div id="modal-notice-box" class="notice-box" style="display: none;">
          <span class="material-symbols-rounded">info</span>
          <span id="modal-notice-text"></span>
        </div>

        <div id="modal-custom-input" style="display: none; margin-top: 1rem;">
           <label style="font-size: 0.8rem; font-weight: bold; display: block; margin-bottom: 0.5rem;">Special Request / Note:</label>
           <textarea id="custom-note-text" class="theme-input" rows="2" placeholder="e.g. Write 'Happy Birthday' on cake"></textarea>
        </div>

        <div class="modal-actions" id="modal-add-wrapper">
           <div class="add-action-wrapper">
             <button class="big-add-btn">ADD TO CART</button>
             <div class="stepper-controls" style="display: none;">
                <button class="minus">-</button>
                <span class="qty-display">1</span>
                <button class="plus">+</button>
             </div>
           </div>
        </div>
      </div>
    </div>
  </div>
</dialog>

  <div class="cart-overlay"></div>

<div class="cart-drawer">
  <div class="cart-header">
    <h3>Your Bag (<span class="cart-count-num">0</span>)</h3>
    <button class="cart-close-btn">
      <span class="material-symbols-rounded">close</span>
    </button>
  </div>

  <div class="cart-items-container">
    <div class="cart-empty-state">Your bag is empty</div>
  </div>

  <div class="cart-footer">
    <div class="cart-total-row">
      <span>Subtotal</span>
      <span class="cart-total-price">$0.00</span>
    </div>
    <button class="checkout-btn">CHECKOUT</button>
  </div>

  <div class="success-toast" id="success-toast">
    <span class="material-symbols-rounded success-icon">check_circle</span>
    <span>Order placed successfully!</span>
  </div>
</div>

<div class="checkout-page" id="checkout-page">
    
    <div class="checkout-header">
      <button class="checkout-back-btn" id="close-checkout-btn">
        <span class="material-symbols-rounded">arrow_back</span>
        Back to Cart
      </button>
      <div class="checkout-brand-title">Checkout</div>
      <div style="width: 24px;"></div>
    </div>

    <div class="checkout-container">
      
      <div class="progress-container">
        <div class="progress-steps">
          <div class="progress-line"></div>
          <div class="p-step active" id="p-step-1">1<span class="p-label">Details</span></div>
          <div class="p-step locked" id="p-step-2">2<span class="p-label">Schedule</span></div>
          <div class="p-step locked" id="p-step-3">3<span class="p-label">Payment</span></div>
        </div>
      </div>

      <div class="checkout-grid">
        
        <div class="checkout-form-col">
          
          <div class="checkout-step active" id="step-1">
            <div class="step-header" onclick="attemptGoToStep(1)">
              <div class="step-title-row">
                <span class="step-number">1</span>
                <h4 class="step-title">Who & Where</h4>
              </div>
              <span class="step-summary" id="summary-1"></span>
              <button class="edit-link">Edit</button>
            </div>
            
            <div class="step-content">
              <div class="form-row">
                <div class="form-group">
                  <label>Name</label>
                  <input type="text" class="theme-input req-1" id="input-name" placeholder="Alen George">
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" class="theme-input req-1" id="input-email" placeholder="alen@example.com">
                </div>
              </div>
              <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" class="theme-input req-1" id="input-phone" placeholder="+91 999...">
              </div>

              <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(0,0,0,0.05);">
                <label style="display:block; margin-bottom: 0.8rem; font-weight: bold;">Delivery Method</label>
                
                <div class="delivery-container">
                  <label class="delivery-option">
                    <input type="radio" name="delivery-mode" value="pickup" checked onchange="toggleDeliveryFields()">
                    <span class="material-symbols-rounded">storefront</span> Pickup
                  </label>
                  <label class="delivery-option">
                    <input type="radio" name="delivery-mode" value="delivery" onchange="toggleDeliveryFields()">
                    <span class="material-symbols-rounded">local_shipping</span> Delivery
                  </label>
                </div>

                <div id="address-fields" style="display: none;">
                  <div class="form-group">
                    <label>Full Address</label>
                    <textarea class="theme-input req-1-delivery" id="input-address" rows="2" placeholder="Flat No, Street, City..."></textarea>
                  </div>
                  <div class="form-group">
                    <label>Pincode</label>
                    <input type="text" class="theme-input req-1-delivery" id="input-pincode" placeholder="682...">
                  </div>
                </div>
                
                <div id="pickup-note" class="info-box" style="background:rgba(196,106,43,0.08); color: var(--theme-brand); border:1px solid rgba(196,106,43,0.1); padding:1rem; border-radius:8px; display:flex; align-items:center; gap:10px;">
                   <span class="material-symbols-rounded">info</span>
                   <span>Pickup at <strong>Sourdough Studio, Panampilly Nagar</strong></span>
                </div>
              </div>

              <button class="continue-btn" onclick="validateAndNext(1)">
                Next: Schedule <span class="material-symbols-rounded">arrow_downward</span>
              </button>
            </div>
          </div>

          <div class="checkout-step collapsed locked" id="step-2">
            <div class="step-header" onclick="attemptGoToStep(2)">
               <div class="step-title-row">
                <span class="step-number">2</span>
                <h4 class="step-title">When</h4>
              </div>
              <span class="step-summary" id="summary-2"></span>
              <button class="edit-link">Edit</button>
            </div>
            
            <div class="step-content">
              <div class="form-row">
                <div class="form-group">
                  <label>Date</label>
                  <input type="date" class="theme-input req-2" id="input-date">
                </div>
                <div class="form-group">
                  <label>Time Slot</label>
                  <div class="select-wrapper">
                    <select class="theme-input" id="input-time">
                      <option>10:00 AM - 12:00 PM</option>
                      <option>12:00 PM - 03:00 PM</option>
                      <option>03:00 PM - 06:00 PM</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="form-group">
                <label>Note (Optional)</label>
                <textarea class="theme-input" id="input-note" rows="2" placeholder="Message on cake, allergies..."></textarea>
              </div>
              <button class="continue-btn" onclick="validateAndNext(2)">
                Next: Payment <span class="material-symbols-rounded">arrow_downward</span>
              </button>
            </div>
          </div>

          <div class="checkout-step collapsed locked" id="step-3">
            <div class="step-header" onclick="attemptGoToStep(3)">
               <div class="step-title-row">
                <span class="step-number">3</span>
                <h4 class="step-title">Payment</h4>
              </div>
              <button class="edit-link">Edit</button>
            </div>
            
            <div class="step-content">
              <div class="payment-options">
                <label class="payment-card">
                  <input type="radio" name="payment" checked>
                  <span class="custom-radio"></span>
                  <div class="payment-info">
                    <span class="payment-title">UPI / Online</span>
                    <span class="payment-desc">GPay, PhonePe, Cards</span>
                  </div>
                </label>
                
                <label class="payment-card">
                  <input type="radio" name="payment">
                  <span class="custom-radio"></span>
                  <div class="payment-info">
                    <span class="payment-title">Pay on Pickup</span>
                    <span class="payment-desc">Cash or QR at store</span>
                  </div>
                </label>
              </div>

               <button class="pay-btn" id="final-pay-btn">
                PAY <span id="pay-btn-amount">₹0.00</span>
              </button>
            </div>
          </div>

        </div>

        <div class="checkout-summary-col">
          <div class="summary-card">
            <h4 class="summary-title">Order Summary</h4>
            <div class="summary-items-list" id="checkout-items-list"></div>
            <div class="summary-divider"></div>
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="checkout-subtotal">₹0.00</span>
            </div>
            <div class="summary-row">
              <span>Delivery Fee</span>
              <span id="checkout-delivery-fee">₹0.00</span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span id="checkout-total">₹0.00</span>
            </div>
            <p class="secure-note"><span class="material-symbols-rounded">lock</span> Secure SSL Checkout</p>
          </div>
        </div>

      </div>
    </div>
  </div>


<style is:inline>
/* =========================================
   CORE VARIABLES & RESET
========================================= */
.store-template-wrapper {
  --spacing-container: 92%;
  --max-width: 1200px;
  
  --theme-brand: #5b3a1e;
  --theme-accent: #c46a2b;
  --theme-page: #fffaf0;
  --theme-ink: #1f1f1f;
  
  --font-display: 'Playfair Display', serif;
  --font-heading: 'Playfair Display', serif;
  --font-body: 'Inter', sans-serif;
  
  background-color: var(--theme-page);
  color: var(--theme-ink);
  font-family: var(--font-body);
  width: 100%;
  min-height: 100%;
  position: relative;
  overflow-x: hidden;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

/* FONT PRESETS */
.store-template-wrapper[data-font-preset="editorial"] { --font-display: 'Playfair Display', serif; --font-heading: 'Playfair Display', serif; --font-body: 'Inter', sans-serif; }
.store-template-wrapper[data-font-preset="editorial"] .store-name { font-style: italic; }

.store-template-wrapper[data-font-preset="modernist"] { --font-display: 'Lexend', sans-serif; --font-heading: 'Lexend', sans-serif; --font-body: 'Inter', sans-serif; }
.store-template-wrapper[data-font-preset="modernist"] .store-name { text-transform: uppercase; letter-spacing: -0.02em; }

.store-template-wrapper[data-font-preset="maker"] { --font-display: 'Dosis', sans-serif; --font-heading: 'Dosis', sans-serif; --font-body: 'Quicksand', sans-serif; }

/* HEADER & HERO */
.store-header { background-color: var(--theme-header-bg, var(--theme-page)); border-bottom: 1px solid rgba(0,0,0,0.08); padding-top: 1.5rem; }
.store-header-inner { display: flex; flex-direction: column; align-items: center; width: var(--spacing-container); max-width: var(--max-width); margin: 0 auto; }
.header-brand-row { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; text-align: center; }
.store-logo-img { height: 60px; width: auto; max-width: 200px; object-fit: contain; margin-bottom: 0.5rem; display: block; }
.store-logo-initial { width: 48px; height: 48px; background-color: var(--theme-brand); color: var(--theme-page); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
.store-name { font-family: var(--font-display); font-size: 2.25rem; line-height: 1.1; color: var(--theme-brand); margin: 0; }

/* HEADER LAYOUT (Left-Right Split) */
.header-nav-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 0.8rem 0;
  border-top: 1px solid rgba(0,0,0,0.06);
  position: relative;
}

/* DESKTOP NAV (Left Aligned) */
.desktop-nav {
  display: flex;
  gap: 3rem;
  margin: 0;
}

/* ACTIONS (Right Aligned) */
.header-actions {
  display: flex;
  gap: 1.25rem;
  align-items: center;
  margin-left: 0;
}

.icon-btn { background: none; border: none; padding: 0; color: var(--theme-ink); cursor: pointer; display: flex; position: relative; }
.icon-btn:hover { color: var(--theme-accent); }
.cart-count { position: absolute; top: -6px; right: -8px; background-color: var(--theme-accent); color: #fff; font-size: 0.65rem; font-weight: 700; height: 16px; width: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

.store-hero { padding: 4rem 1rem 2rem; text-align: center; max-width: 800px; margin: 0 auto; }
.store-tagline { font-family: var(--font-display); font-size: 2.5rem; line-height: 1.2; margin-bottom: 1.5rem; color: var(--theme-ink); }
.store-about-preview p { font-size: 1.05rem; line-height: 1.7; opacity: 0.85; color: var(--theme-ink); margin-bottom: 2rem; white-space: pre-wrap; }

/* CATEGORY BAR */
.category-bar-wrapper { width: var(--spacing-container); max-width: var(--max-width); margin: 0 auto 3rem; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 10px; }
.category-scroll { display: flex; gap: 0.8rem; justify-content: center; }
.category-pill { padding: 0.6rem 1.5rem; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); background: transparent; color: var(--theme-ink); font-size: 0.85rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
.category-pill:hover { border-color: var(--theme-accent); color: var(--theme-accent); }
.category-pill.active { background: var(--theme-brand); color: white; border-color: var(--theme-brand); }

/* PRODUCTS */
.store-products { padding: 0 0 4rem; width: var(--spacing-container); max-width: var(--max-width); margin: 0 auto; }
.products-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2.5rem; }
.product-card { display: flex; flex-direction: column; cursor: pointer; position: relative; transition: transform 0.3s ease; }
.product-image { position: relative; aspect-ratio: 1; overflow: hidden; background: rgba(0,0,0,0.03); margin-bottom: 1rem; }
.product-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
.product-content { display: flex; flex-direction: column; flex: 1; }
.product-name { font-family: var(--font-heading); font-size: 1.15rem; margin: 0 0 0.25rem; color: var(--theme-ink); }
.product-short-desc { font-size: 0.85rem; opacity: 0.6; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; min-height: 2.8em; }
.product-footer { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.product-price { font-weight: 600; color: var(--theme-accent); font-size: 1.1rem; }

/* MORPHING BUTTON */
/* BASE BUTTON STYLES */
.add-action-wrapper { 
  min-height: 40px; /* Allow it to grow if stepper is taller */
  height: auto;     /* Fixes the cutoff bug */
  margin-top: auto; 
  width: 100%; 
  display: flex; 
  justify-content: flex-start; 
}
.big-add-btn {
  height: 100%; 
  background-color: var(--theme-accent); 
  color: white; border: none; border-radius: 4px; 
  font-weight: 700; font-size: 0.8rem; letter-spacing: 0.05em; text-transform: uppercase; 
  cursor: pointer; transition: all 0.2s; 
  
  /* ✅ FIX: We removed '!important' from display so it can be hidden! */
  display: flex; 
  justify-content: center !important; 
  align-items: center !important;
  text-align: center !important;
}

.big-add-btn:hover { opacity: 0.9; transform: translateY(-1px); }
/* --- PREMIUM STEPPER (COMPACT & BOLD) --- */
.stepper-controls {
  /* 1. Compact & Solid Dimensions */
  width: 120px !important;  /* Shorter width (was 140px) */
  height: 44px !important;  /* Nice touch target height */
  
  /* 2. Stronger Visuals */
  border: 1.5px solid var(--theme-ink); /* Thicker border looks premium */
  border-radius: 50px;
  background: transparent;
  
  /* 3. Layout */
  display: flex; 
  align-items: center; 
  justify-content: space-between;
  padding: 0 4px; /* Tiny padding for the buttons */
  margin: 0;
}

#product-modal .stepper-controls {
  width: 100% !important;  /* Stretch to fill modal width */
  padding: 0 1rem;         /* Add breathing room for +/- */
  justify-content: space-between; /* Push - and + to edges */
}

/* The Plus/Minus Buttons */
.stepper-controls button {
  width: 36px; 
  height: 36px; /* Perfect circle touch target */
  border-radius: 50%;
  
  display: flex; 
  align-items: center; 
  justify-content: center;
  
  border: none; 
  background: transparent;
  color: var(--theme-ink);
  
  font-size: 1.6rem !important; /* Big, bold symbols */
  font-weight: 400;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
  
  /* Fix vertical alignment of symbols */
  padding-bottom: 4px; 
}

/* Hover Effect (The "Tactile" Feel) */
.stepper-controls button:hover {
  background: rgba(0,0,0,0.08); /* Subtle grey circle on hover */
}
.stepper-controls button:active {
  transform: scale(0.9); /* Tiny press animation */
}

/* The Number in the middle */
.qty-display {
  font-family: var(--font-body);
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--theme-ink);
  min-width: 20px; text-align: center;
}

.card-badges { position: absolute; top: 10px; left: 10px; z-index: 5; display: flex; gap: 5px; }
.icon-badge { background: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--theme-ink); }

/* LAYOUT VARIATIONS */
.store-template-wrapper[data-layout="natural"] .product-image { border-radius: 12px; }
.store-template-wrapper[data-layout="natural"] .big-add-btn { border-radius: 50px; }
.store-template-wrapper[data-layout="natural"] .stepper-controls { border-radius: 50px; }
.store-template-wrapper[data-layout="natural"] .product-card:hover .product-image img { transform: scale(1.05); }

.store-template-wrapper[data-layout="gallery"] .product-image { border-radius: 2px; border: 1px solid rgba(0,0,0,0.08); }
.store-template-wrapper[data-layout="gallery"] .big-add-btn { border-radius: 0; background: var(--theme-ink); }
.store-template-wrapper[data-layout="gallery"] .stepper-controls { border-radius: 0; }
.store-template-wrapper[data-layout="gallery"] .product-card:hover .product-image img { opacity: 0.9; }

.store-template-wrapper[data-layout="pop"] .product-card { background-color: #fff; padding: 12px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
.store-template-wrapper[data-layout="pop"] .product-image { border-radius: 14px; }
.store-template-wrapper[data-layout="pop"] .big-add-btn { border-radius: 12px; font-weight: 800; border: 2px solid var(--theme-ink); color: var(--theme-ink); background: white; }
.store-template-wrapper[data-layout="pop"] .big-add-btn:hover { background: var(--theme-accent); color: white; border-color: var(--theme-accent); }
.store-template-wrapper[data-layout="pop"] .stepper-controls { border-radius: 12px; border: 2px solid var(--theme-ink); }
.store-template-wrapper[data-layout="pop"] .product-card:hover { transform: translateY(-5px); }

/* MODAL STYLES */
dialog.product-modal { border: none; border-radius: 16px; padding: 0; max-width: 800px; width: 90%; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); background: var(--theme-page); color: var(--theme-ink); }
dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
.modal-wrapper { position: relative; }
.modal-close-btn { position: absolute; top: 1rem; right: 1rem; z-index: 10; background: rgba(255,255,255,0.8); border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.modal-content { display: grid; grid-template-columns: 1fr 1fr; }
.modal-image-col img { width: 100%; height: 100%; object-fit: cover; min-height: 300px; }
.modal-info-col { padding: 2.5rem; display: flex; flex-direction: column; gap: 1rem; }
.modal-title { font-family: var(--font-heading); font-size: 1.8rem; margin: 0; line-height: 1.1; color: var(--theme-brand); }
.modal-price { font-size: 1.25rem; font-weight: 600; color: var(--theme-accent); }
.modal-desc { opacity: 0.8; line-height: 1.6; margin-bottom: 1rem; }
.modal-notice-box { background: #FFF8E1; color: #795548; padding: 0.75rem; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; border: 1px solid #FFE082; }
.modal-custom-input textarea { width: 100%; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 0.5rem; font-family: inherit; font-size: 0.9rem; background: rgba(255,255,255,0.5); resize: none; height: 60px; }
.store-template-wrapper[data-layout="gallery"] dialog.product-modal { border-radius: 0; }

/* FOOTER */
.store-footer { margin-top: auto; padding: 4rem 0 2rem; border-top: 1px solid rgba(0,0,0,0.05); background-color: var(--theme-header-bg, var(--theme-page)); color: var(--theme-ink); }
.footer-container { width: var(--spacing-container); max-width: var(--max-width); margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 3rem; margin-bottom: 3rem; }
.footer-brand-name { font-family: var(--font-display); font-size: 1.75rem; margin-top: 0.5rem; color: var(--theme-brand); line-height: 1.1; }
.footer-logo-img { height: 40px; width: auto; object-fit: contain; margin-bottom: 0.5rem; display: block; }
.footer-col h5 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 1.25rem; opacity: 0.5; font-weight: 700; color: var(--theme-ink); }
.contact-col, .social-col { display: flex; flex-direction: column; gap: 0.75rem; }
.contact-link, .social-link { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; text-decoration: none; color: var(--theme-ink); transition: color 0.2s; }
.contact-link:hover, .social-link:hover { color: var(--theme-accent); }
.footer-bottom { border-top: 1px solid rgba(0,0,0,0.05); padding-top: 1.5rem; text-align: center; font-size: 0.8rem; opacity: 0.4; }

/* FOOTER ADDRESS & EMAIL FIXES */
.footer-address-text {
  white-space: normal; 
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  line-height: 1.5;
  max-width: 90%;
  opacity: 0.8;
}

.footer-col { min-width: 0; }

.footer-email-text {
  overflow-wrap: anywhere; 
  display: block; 
}

/* NAVIGATION LINKS */
.nav-link {
  text-decoration: none;
  color: var(--theme-ink);
  font-family: var(--font-body);
  font-weight: 600;
  font-size: 0.9rem;
  cursor: pointer;
  position: relative;
  transition: color 0.2s ease;
}

.nav-link:hover { color: var(--theme-accent); }

.nav-link::after {
  content: '';
  position: absolute;
  width: 0;
  height: 2px;
  bottom: -4px;
  left: 0;
  background-color: var(--theme-accent);
  transition: width 0.2s ease;
}

.nav-link:hover::after { width: 100%; }

/* SCROLL & BUMPER */
html { scroll-behavior: smooth; }
section[id] { scroll-margin-top: 100px; }

/* MOBILE MENU STYLES */
.mobile-menu-btn {
  display: none; /* Hidden on Desktop */
  background: none;
  border: none;
  cursor: pointer;
  color: var(--theme-ink);
  padding: 0;
}

.mobile-menu-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 100;
  display: none;
  opacity: 0;
  transition: opacity 0.3s;
}

.mobile-menu-overlay.open { display: flex; opacity: 1; }

.mobile-menu-container {
  width: 80%;
  max-width: 300px;
  height: 100%;
  background: var(--theme-page);
  padding: 2rem;
  box-shadow: 2px 0 10px rgba(0,0,0,0.1);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.mobile-menu-overlay.open .mobile-menu-container { transform: translateX(0); }

.mobile-close-btn {
  align-self: flex-end;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--theme-ink);
  margin-bottom: 2rem;
}

.mobile-links {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.mobile-link {
  font-size: 1.25rem;
  font-family: var(--font-heading);
  text-decoration: none;
  color: var(--theme-ink);
  font-weight: 600;
}

/* --- MOBILE RESPONSIVENESS (Max Width 768px) --- */
@media (max-width: 768px) {
  .store-header { padding-top: 1rem; }
  
  /* Navigation Logic */
  .desktop-nav { display: none !important; }
  .mobile-menu-btn { display: block; }
  .header-nav-row { justify-content: space-between; }

  /* Product Grid */
  .products-grid { grid-template-columns: 1fr; gap: 2rem; }
  
  /* Category Scroll */
  .category-scroll { justify-content: flex-start; padding-left: 1rem; }
  
  /* Footer */
  .footer-container { grid-template-columns: 1fr; gap: 2rem; text-align: center; }
  .footer-col { align-items: center; }
  
  /* Modal */
  .modal-content { grid-template-columns: 1fr; }
  .modal-image-col { height: 250px; }
  .modal-info-col { padding: 1.5rem; }
}
/* --- CART DRAWER (THE STICKY SANDWICH LAYOUT) --- */
.cart-overlay {
  position: fixed; /* Locks to screen, not page */
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4); z-index: 100;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
  backdrop-filter: blur(2px);
}
.cart-overlay.open { opacity: 1; pointer-events: all; }

.cart-drawer {
  position: fixed; /* CRITICAL: Locks drawer to the Window Viewport */
  top: 0; right: 0; 
  width: 100%; max-width: 480px; 
  height: 100%; /* Forces it to be exactly screen height */
  
  background: var(--theme-page); z-index: 101;
  box-shadow: -10px 0 40px rgba(0,0,0,0.1);
  transform: translateX(100%); 
  transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  
  /* THE SANDWICH MAGIC */
  display: flex; 
  flex-direction: column; 
}
.cart-drawer.open { transform: translateX(0); }

/* ZONE A: TOP BREAD (Header) */
.cart-header {
  flex-shrink: 0; /* Never squash */
  padding: 1.5rem 2rem; 
  border-bottom: 1px solid rgba(0,0,0,0.05);
  display: flex; justify-content: space-between; align-items: center;
}
.cart-header h3 { font-family: var(--font-heading); margin: 0; font-size: 1.5rem; color: var(--theme-brand); }
.cart-close-btn { background: none; border: none; cursor: pointer; color: var(--theme-ink); transition: transform 0.2s; }
.cart-close-btn:hover { transform: scale(1.1); }

/* ZONE B: FILLING (Scrollable Middle) */
.cart-items-container { 
  flex-grow: 1;           /* Take up ALL available space */
  overflow-y: auto;       /* Scroll internally if list is long */
  padding: 0 2rem;
  display: flex; flex-direction: column; 
  
  /* Pretty Scrollbar */
  scrollbar-width: thin;
  scrollbar-color: var(--theme-accent) transparent;
}
/* Scrollbar polish */
.cart-items-container::-webkit-scrollbar { width: 6px; }
.cart-items-container::-webkit-scrollbar-track { background: transparent; }
.cart-items-container::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.1); border-radius: 20px; }

.cart-empty-state { text-align: center; opacity: 0.5; padding: 3rem 0; font-family: var(--font-heading); font-size: 1.2rem; }

/* Item Styling */
.cart-item { display: flex; gap: 1.5rem; position: relative; padding: 2rem 0; border-bottom: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
.cart-item:last-child { border-bottom: none; }
.cart-item-img { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; background: #f0f0f0; flex-shrink: 0; }
.cart-item-details { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
.cart-item-top { padding-right: 20px; }
.cart-item-title { font-family: var(--font-heading); font-size: 1.1rem; margin: 0 0 4px 0; line-height: 1.3; color: var(--theme-ink); }
.cart-item-variant { font-size: 0.8rem; opacity: 0.6; font-family: var(--font-body); }
.cart-remove-btn { position: absolute; top: 2rem; right: 0; background: none; border: none; cursor: pointer; color: var(--theme-ink); opacity: 0.4; padding: 5px; transition: all 0.2s; }
.cart-remove-btn:hover { opacity: 1; color: #e53935; background: rgba(0,0,0,0.03); border-radius: 50%; }
.cart-item-bottom { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 1rem; }
.cart-item-price { font-weight: 700; font-size: 1.1rem; color: var(--theme-ink); }

/* ZONE C: BOTTOM BREAD (Sticky Footer) */
.cart-footer { 
  flex-shrink: 0; /* Never squash */
  padding: 2rem; 
  border-top: 1px solid rgba(0,0,0,0.05); 
  background: var(--theme-page); 
  z-index: 10;
  margin-top: auto; /* Pushes to bottom if list is short */
}
.cart-total-row { display: flex; justify-content: space-between; font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--theme-brand); }
.checkout-btn { width: 100%; padding: 1.2rem; background: var(--theme-accent); color: #fff; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; font-size: 0.9rem; letter-spacing: 0.05em; text-transform: uppercase; transition: opacity 0.2s, transform 0.2s; }
.checkout-btn:hover { opacity: 0.9; transform: translateY(-2px); }

/* --- [NEW] SUCCESS TOAST NOTIFICATION --- */
.success-toast {
  position: absolute;
  top: 2rem; left: 50%;
  transform: translateX(-50%) translateY(-100px); /* Start hidden above */
  background: #1e1e1e; /* Dark styling */
  color: #fff;
  padding: 1rem 2rem;
  border-radius: 50px;
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
  z-index: 200;
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  font-family: var(--font-body);
  font-weight: 600;
  pointer-events: none;
}
.success-toast.show {
  transform: translateX(-50%) translateY(0); /* Slide down */
  opacity: 1;
}
.success-icon { color: #4CAF50; font-size: 1.2rem; }

@media (max-width: 600px) {
  .cart-drawer { max-width: 100%; }
  .cart-item-img { width: 70px; height: 70px; }
}

/* --- CHECKOUT PAGE (ACCORDION WIZARD) --- */
.checkout-page {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  background-color: var(--theme-page);
  z-index: 200; 
  display: flex; flex-direction: column;
  transform: translateY(100%); visibility: hidden; 
  transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), visibility 0.4s;
  overflow-y: auto; 
}
.checkout-page.open { transform: translateY(0); visibility: visible; }

.checkout-header {
  padding: 1rem 2rem;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid rgba(0,0,0,0.05);
  background: var(--theme-page);
  position: sticky; top: 0; z-index: 10;
}
.checkout-back-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-family: var(--font-body); font-weight: 600; color: var(--theme-ink); opacity: 0.7; }
.checkout-brand-title { font-family: var(--font-heading); font-size: 1.5rem; color: var(--theme-brand); }

.checkout-container { max-width: 1100px; margin: 0 auto; width: 100%; padding: 2rem; }
.checkout-grid { display: grid; grid-template-columns: 1.8fr 1fr; gap: 4rem; }

/* --- PROGRESS BAR --- */
.progress-container { grid-column: 1 / -1; display: flex; justify-content: center; margin-bottom: 3rem; }
.progress-steps { display: flex; align-items: center; gap: 1rem; position: relative; }
.progress-line {
  position: absolute; top: 50%; left: 0; width: 100%; height: 2px;
  background: rgba(0,0,0,0.1); z-index: 0; transform: translateY(-50%);
}
.p-step {
  width: 32px; height: 32px; border-radius: 50%;
  background: var(--theme-page); border: 2px solid rgba(0,0,0,0.1);
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 0.9rem; color: rgba(0,0,0,0.4);
  z-index: 1; position: relative; transition: all 0.3s;
}
.p-step.active {
  border-color: var(--theme-accent); color: var(--theme-accent);
  box-shadow: 0 0 0 4px rgba(196, 106, 43, 0.1);
}
.p-step.completed { background: var(--theme-accent); border-color: var(--theme-accent); color: white; }
.p-label {
  position: absolute; top: 40px; white-space: nowrap; font-size: 0.75rem;
  font-weight: 600; opacity: 0; transition: opacity 0.2s;
}
.p-step.active .p-label { opacity: 1; color: var(--theme-accent); }

/* --- ACCORDION STEPS --- */
.checkout-step {
  background: white; border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.08);
  margin-bottom: 1.5rem; overflow: hidden;
  transition: all 0.3s ease;
}

/* LOCKING LOGIC */
.checkout-step.locked {
  opacity: 0.5; 
  pointer-events: none; /* Prevents clicking */
  filter: grayscale(100%);
}

.checkout-step.collapsed .step-content { display: none; }
.checkout-step.active {
  border-color: var(--theme-accent);
  box-shadow: 0 8px 25px rgba(0,0,0,0.05); opacity: 1;
}

.step-header {
  padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;
  background: rgba(0,0,0,0.01); cursor: pointer;
}
.step-title-row { display: flex; align-items: center; gap: 1rem; }
.step-number { 
  font-weight: 700; color: white; background: var(--theme-accent); 
  width: 28px; height: 28px; border-radius: 50%; 
  display: flex; align-items: center; justify-content: center; font-size: 0.9rem;
}
.step-title { font-family: var(--font-heading); font-size: 1.2rem; margin: 0; }
.step-summary {
  font-size: 0.9rem; opacity: 0.6; margin-right: auto; padding-left: 1.5rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;
}
.edit-link {
  font-size: 0.85rem; text-decoration: underline; color: var(--theme-accent);
  background: none; border: none; cursor: pointer; display: none;
}
.checkout-step.collapsed .edit-link { display: block; }
.checkout-step.collapsed .step-summary { display: block; }
.checkout-step.active .step-summary { display: none; }

.step-content { padding: 2rem; border-top: 1px solid rgba(0,0,0,0.05); }

/* Form Elements */
.form-group { margin-bottom: 1.2rem; display: flex; flex-direction: column; gap: 0.5rem; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.theme-input { padding: 0.9rem; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: inherit; width: 100%; font-size: 1rem; transition: all 0.2s; }
.theme-input:focus { outline: none; border-color: var(--theme-accent); background: white; box-shadow: 0 0 0 3px rgba(196, 106, 43, 0.1); }
.continue-btn {
  width: 100%; padding: 1.2rem; background: var(--theme-ink); color: white;
  border: none; border-radius: 50px; font-weight: bold; cursor: pointer; margin-top: 1.5rem;
  display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 1rem;
}
.continue-btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* --- [NEW] PREMIUM DELIVERY TOGGLE --- */
.delivery-container {
  background: rgba(0,0,0,0.03); padding: 5px; border-radius: 12px;
  display: flex; margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.05);
}
.delivery-container input { display: none; }
.delivery-option {
  flex: 1; text-align: center; padding: 12px; cursor: pointer;
  border-radius: 8px; font-weight: 600; color: #666; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.delivery-container input:checked + .delivery-option {
  background: white; color: var(--theme-accent);
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* --- [NEW] PREMIUM PAYMENT CARDS --- */
.payment-options { display: flex; flex-direction: column; gap: 1rem; }
.payment-card {
  border: 1px solid rgba(0,0,0,0.1); padding: 1.2rem; border-radius: 12px;
  display: flex; align-items: center; gap: 1rem; cursor: pointer; 
  transition: all 0.2s; background: white;
}
.payment-card:hover { border-color: var(--theme-accent); }
/* Custom Radio Circle */
.custom-radio {
  width: 20px; height: 20px; border-radius: 50%;
  border: 2px solid #ddd; position: relative;
  display: flex; align-items: center; justify-content: center;
}
.custom-radio::after {
  content: ''; width: 10px; height: 10px; background: var(--theme-accent);
  border-radius: 50%; opacity: 0; transition: opacity 0.2s;
}
/* Selected State */
.payment-card input:checked ~ .custom-radio { border-color: var(--theme-accent); }
.payment-card input:checked ~ .custom-radio::after { opacity: 1; }
.payment-card:has(input:checked) { 
  border-color: var(--theme-accent); 
  background: rgba(196, 106, 43, 0.03); 
}
.payment-card input { display: none; } /* Hide default ugly radio */

.pay-btn {
  width: 100%; padding: 1.2rem; margin-top: 1.5rem; background: var(--theme-accent); color: white;
  border: none; border-radius: 12px; font-weight: 800; font-size: 1.1rem; cursor: pointer;
  transition: transform 0.2s, opacity 0.2s; letter-spacing: 0.05em; text-transform: uppercase;
}
.pay-btn:hover { transform: translateY(-2px); opacity: 0.9; }

/* SUMMARY (Keep professional look) */
.summary-card {
  background: #fff; border: 1px solid rgba(0,0,0,0.08); 
  border-radius: 16px; padding: 2rem; position: sticky; top: 100px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.02);
}
.summary-title { font-family: var(--font-heading); font-size: 1.4rem; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 1rem; }
.summary-items-list { display: flex; flex-direction: column; gap: 1.2rem; margin-bottom: 2rem; max-height: 350px; overflow-y: auto; padding-right: 5px; }
.summary-item { display: flex; gap: 1rem; align-items: flex-start; }
.s-item-img { width: 64px; height: 64px; border-radius: 8px; object-fit: cover; border: 1px solid rgba(0,0,0,0.05); flex-shrink: 0; }
.s-item-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-height: 64px; }
.s-item-name { font-weight: 700; font-size: 1rem; color: var(--theme-ink); line-height: 1.3; }
.s-item-meta { font-size: 0.85rem; color: #888; margin-top: 4px; }
.s-item-price { font-weight: 700; font-size: 1rem; margin-left: auto; align-self: center; }
.summary-divider { height: 1px; background: rgba(0,0,0,0.08); margin: 1.5rem 0; border-style: dashed; }
.summary-row { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.95rem; color: #555; }
.summary-row.total { font-weight: 800; font-size: 1.4rem; color: var(--theme-brand); margin-top: 1rem; align-items: flex-end; }
.secure-note { text-align: center; font-size: 0.8rem; opacity: 0.5; margin-top: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 6px; }

@media (max-width: 900px) { .checkout-grid { grid-template-columns: 1fr; gap: 2rem; } .checkout-summary-col { order: -1; } }

/* --- PRODUCT MODAL (FIXED: 2-COLUMN LAYOUT) --- */
.product-modal {
  border: none; padding: 0; 
  border-radius: 20px;
  background: transparent;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  max-width: 900px; width: 95%;
  overflow: hidden; /* Clips the image corners */
}

.product-modal::backdrop {
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(4px);
}

.modal-content {
  background: var(--theme-page); 
  position: relative;
  display: flex; flex-direction: column;
}

.modal-close-btn {
  position: absolute; top: 1rem; right: 1rem;
  background: rgba(255,255,255,0.8); 
  border: none; border-radius: 50%;
  width: 36px; height: 36px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; z-index: 10;
  transition: transform 0.2s;
  color: var(--theme-ink);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.modal-close-btn:hover { transform: scale(1.1); }

/* LAYOUT: SPLIT VIEW */
.modal-body {
  display: flex;
  flex-direction: column; /* Mobile First: Stack */
}

/* DESKTOP: SIDE BY SIDE */
@media (min-width: 768px) {
  .modal-body { flex-direction: row; min-height: 500px; }
  
  .modal-img-wrapper { 
    width: 50%; 
    height: auto; /* Fill height */
    position: relative;
  }
  
  .modal-info { 
    width: 50%; 
    padding: 3rem; /* More breathing room */
    display: flex; flex-direction: column;
    justify-content: center; /* Center content vertically */
  }
}

.modal-img-wrapper img {
  width: 100%; height: 100%;
  object-fit: cover;
  display: block;
}

/* INFO STYLING */
.modal-info { padding: 1.5rem; }

#modal-title {
  font-family: var(--font-heading);
  font-size: 2rem; margin: 0 0 0.5rem 0;
  color: var(--theme-brand);
  line-height: 1.2;
}

#modal-price {
  font-size: 1.25rem; font-weight: 700;
  color: var(--theme-accent);
  margin-bottom: 1.5rem;
}

#modal-desc {
  font-family: var(--font-body);
  line-height: 1.6; opacity: 0.8;
  margin-bottom: 1.5rem; font-size: 0.95rem;
}

/* NOTICE BOX (The Yellow Pill) */
.notice-box {
  background: #fff9c4; /* Pastel Yellow */
  color: #856404; /* Dark Yellow/Brown text */
  padding: 0.8rem 1rem;
  border-radius: 8px;
  font-size: 0.85rem; font-weight: 500;
  display: flex; align-items: center; gap: 8px;
  margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.05);
}

/* CUSTOM NOTE INPUT */
#modal-custom-input label {
  font-family: var(--font-heading);
  color: var(--theme-ink);
}
#modal-custom-input textarea {
  background: rgba(0,0,0,0.03);
  border: 1px solid rgba(0,0,0,0.1);
  resize: none;
}
#modal-custom-input textarea:focus {
  background: #fff;
  border-color: var(--theme-accent);
}

/* ACTION BUTTONS */
.modal-actions { margin-top: 2rem; }
.add-action-wrapper { 
  min-height: 40px; 
  height: auto; 
  margin-top: auto; 
  width: 100%; 
  display: flex; 
  justify-content: flex-start; 
}
.big-add-btn {
  padding: 0.9rem 2rem;
  background: var(--theme-accent);
  color: #fff;
  border: none;
  border-radius: 50px;
  font-weight: 700;
  cursor: pointer;
  font-size: 0.9rem;
  letter-spacing: 0.05em;
  text-transform: uppercase;
  transition: background 0.2s, transform 0.2s;
}
</style>
<script>
  // ==========================================
  // 1. DATA & STATE
  // ==========================================
  const wrapper = document.querySelector('.store-template-wrapper');
  const productsData = wrapper.dataset.products ? JSON.parse(wrapper.dataset.products) : [];
  
  const cartState = {}; // { productId: quantity }
  const cartNotes = {}; // { productId: "Custom Note Text" }

  // ==========================================
  // 2. MAIN SYNC FUNCTION (UI UPDATES)
  // ==========================================
  function syncUI(id, qty) {
    // Target both Card Buttons and Modal Buttons
    const wrappers = document.querySelectorAll(`[data-id="${id}"] .add-action-wrapper, #modal-add-wrapper[data-id="${id}"]`);
    
    wrappers.forEach(wrapper => {
        const bigBtn = wrapper.querySelector('.big-add-btn');
        const stepper = wrapper.querySelector('.stepper-controls');
        const display = wrapper.querySelector('.qty-display');

        if (qty > 0) {
            if(bigBtn) bigBtn.style.display = 'none';
            if(stepper) stepper.style.display = 'flex';
            if(display) display.textContent = qty;
        } else {
            if(stepper) stepper.style.display = 'none';
            if(bigBtn) bigBtn.style.display = 'flex';
        }
    });

    // Update Header Badge
    const totalItems = Object.values(cartState).reduce((a, b) => a + b, 0);
    document.querySelectorAll('.cart-count').forEach(el => el.textContent = totalItems);
    
    const cartCountNum = document.querySelector('.cart-count-num');
    if(cartCountNum) cartCountNum.textContent = totalItems;

    renderCart(); // Keep drawer updated
  }

  // ==========================================
  // 3. RENDER CART DRAWER
  // ==========================================
  function renderCart() {
    const container = document.querySelector('.cart-items-container');
    const totalPriceEl = document.querySelector('.cart-total-price');
    if(!container) return; 

    container.innerHTML = '';
    let total = 0;
    let hasItems = false;

    Object.entries(cartState).forEach(([pid, qty]) => {
        if(qty > 0) {
            hasItems = true;
            const product = productsData.find(p => p.id == pid);
            if(!product) return;
            total += product.price * qty;

            const itemHTML = `
                <div class="cart-item">
                    <img src="${product.image}" class="cart-item-img" alt="${product.name}">
                    <div class="cart-item-details">
                        <div class="cart-item-top">
                            <h4 class="cart-item-title">${product.name}</h4>
                            <div class="cart-item-variant">Standard</div>
                        </div>
                        <button class="cart-remove-btn" onclick="updateCartItem('${pid}', 0)" title="Remove">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                        <div class="cart-item-bottom">
                            <span class="cart-item-price">₹${(product.price * qty).toFixed(2)}</span>
                            <div class="mini-stepper">
                                <button class="mini-step-btn" onclick="updateCartItem('${pid}', ${qty - 1})">-</button>
                                <span class="mini-step-qty">${qty}</span>
                                <button class="mini-step-btn" onclick="updateCartItem('${pid}', ${qty + 1})">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', itemHTML);
        }
    });

    if(!hasItems) container.innerHTML = '<div class="cart-empty-state">Your bag is empty</div>';
    if(totalPriceEl) totalPriceEl.textContent = `₹${total.toFixed(2)}`;
  }

  window.updateCartItem = function(pid, newQty) {
    if(newQty < 0) newQty = 0;
    cartState[pid] = newQty;
    syncUI(pid, newQty);
  };

  // ==========================================
  // 4. ADD TO CART LOGIC (CARDS & MODAL)
  // ==========================================
  function attachStepperLogic(wrapper, productId) {
    const bigBtn = wrapper.querySelector('.big-add-btn');
    const plus = wrapper.querySelector('.plus');
    const minus = wrapper.querySelector('.minus');
    if(!bigBtn) return;

    // Clone to strip old listeners
    const newBig = bigBtn.cloneNode(true);
    const newPlus = plus.cloneNode(true);
    const newMinus = minus.cloneNode(true);
    bigBtn.parentNode.replaceChild(newBig, bigBtn);
    plus.parentNode.replaceChild(newPlus, plus);
    minus.parentNode.replaceChild(newMinus, minus);

    // ADD BUTTON CLICK
    newBig.addEventListener('click', (e) => {
        e.stopPropagation();
        
        // Capture Note if inside Modal
        const noteInput = document.getElementById('custom-note-text');
        const modalWrapper = document.getElementById('modal-add-wrapper');
        if(wrapper === modalWrapper && noteInput && noteInput.value.trim() !== "") {
             cartNotes[productId] = noteInput.value.trim();
             noteInput.value = "";
        }

        cartState[productId] = 1;
        syncUI(productId, 1);
        toggleCart(true); 
        
        // Close modal if open
        const modal = document.getElementById('product-modal');
        if(modal && modal.open) modal.close();
    });

    newPlus.addEventListener('click', (e) => { e.stopPropagation(); cartState[productId] = (cartState[productId] || 0) + 1; syncUI(productId, cartState[productId]); });
    newMinus.addEventListener('click', (e) => { e.stopPropagation(); cartState[productId] = Math.max(0, (cartState[productId] || 0) - 1); syncUI(productId, cartState[productId]); });
  }

  // Initialize Product Cards
  document.querySelectorAll('.product-card').forEach(card => {
    const pid = card.dataset.id;
    const wrapper = card.querySelector('.add-action-wrapper');
    if(wrapper) attachStepperLogic(wrapper, pid);
  });
  
  // ==========================================
  // 5. MODAL LOGIC
  // ==========================================
  const modal = document.getElementById('product-modal');
  const modalWrapper = document.getElementById('modal-add-wrapper');
  
  const mImg = document.getElementById('modal-img');
  const mTitle = document.getElementById('modal-title');
  const mPrice = document.getElementById('modal-price');
  const mDesc = document.getElementById('modal-desc');
  const mNotice = document.getElementById('modal-notice-box');
  const mNoticeText = document.getElementById('modal-notice-text');
  const mCustom = document.getElementById('modal-custom-input');
  const mCustomText = document.getElementById('custom-note-text');

  document.querySelectorAll('.product-card').forEach(card => {
      card.addEventListener('click', (e) => {
          if(e.target.closest('.add-action-wrapper')) return; // Ignore clicks on button
          
          const data = JSON.parse(card.dataset.product);
          const pid = card.dataset.id;

          // Fill Data
          mImg.src = data.image;
          mTitle.textContent = data.name;
          mPrice.textContent = `₹${data.price.toFixed(2)}`;
          mDesc.textContent = data.full_details || data.description; 
          
          if (data.product_notice) {
            mNotice.style.display = 'flex';
            mNoticeText.textContent = data.product_notice;
          } else { mNotice.style.display = 'none'; }
          
          // Show Note Field?
          if (data.accepts_custom_note) {
              mCustom.style.display = 'block';
              mCustomText.value = cartNotes[pid] || "";
          } else { 
              mCustom.style.display = 'none'; 
              mCustomText.value = "";
          }

          if(modalWrapper) {
            modalWrapper.dataset.id = pid;
            attachStepperLogic(modalWrapper, pid);
            syncUI(pid, cartState[pid] || 0); // Update button state
          }
          if(modal) modal.showModal();
      });
  });
  
  const productModalClose = document.querySelector('.modal-close-btn'); 
  if(productModalClose) productModalClose.addEventListener('click', () => modal.close());
  if(modal) modal.addEventListener('click', (e) => { if(e.target === modal) modal.close(); });


  // ==========================================
  // 6. NAVIGATION & DRAWERS
  // ==========================================
  const cartDrawer = document.querySelector('.cart-drawer');
  const cartOverlay = document.querySelector('.cart-overlay');
  
  function toggleCart(open) {
    if(open) {
        cartDrawer.classList.add('open');
        cartOverlay.classList.add('open');
    } else {
        cartDrawer.classList.remove('open');
        cartOverlay.classList.remove('open');
    }
  }

  const cartBtn = document.querySelector('.cart-btn');
  const cartCloseBtn = document.querySelector('.cart-close-btn');
  if(cartBtn) cartBtn.addEventListener('click', () => toggleCart(true));
  if(cartCloseBtn) cartCloseBtn.addEventListener('click', () => toggleCart(false));
  if(cartOverlay) cartOverlay.addEventListener('click', () => toggleCart(false));

 // ==========================================
  // CHECKOUT LOGIC (LOCKED WIZARD)
  // ==========================================
  const checkoutTriggerBtn = document.querySelector('.checkout-btn');
  const checkoutPage = document.getElementById('checkout-page');
  const checkoutBackBtn = document.getElementById('close-checkout-btn');
  
  // TRACKING STEP PROGRESS
  let maxStepReached = 1;

  if(checkoutTriggerBtn) {
    checkoutTriggerBtn.addEventListener('click', () => {
        const totalQty = Object.values(cartState).reduce((a,b)=>a+b,0);
        if(totalQty === 0) { alert("Your bag is empty!"); return; }
        toggleCart(false); 
        checkoutPage.classList.add('open'); 
        renderCheckoutSummary(); 
        
        // Reset state on open
        maxStepReached = 1;
        document.getElementById('step-2').classList.add('locked');
        document.getElementById('step-3').classList.add('locked');
        document.getElementById('p-step-2').classList.add('locked');
        document.getElementById('p-step-3').classList.add('locked');
        forceGoToStep(1); 
    });
  }
  if(checkoutBackBtn) {
    checkoutBackBtn.addEventListener('click', () => {
        checkoutPage.classList.remove('open');
        toggleCart(true); 
    });
  }

  // Called when clicking header. Only allows if step is unlocked.
  window.attemptGoToStep = function(step) {
      if(step > maxStepReached) return; // BLOCKED!
      forceGoToStep(step);
  };

  // Internal function to actually move
  function forceGoToStep(step) {
      document.querySelectorAll('.checkout-step').forEach(el => {
          el.classList.add('collapsed'); el.classList.remove('active');
      });
      const activeStep = document.getElementById(`step-${step}`);
      if(activeStep) { activeStep.classList.remove('collapsed'); activeStep.classList.add('active'); }
      
      // Update Progress Bar
      for(let i=1; i<=3; i++) {
          const pStep = document.getElementById(`p-step-${i}`);
          pStep.classList.remove('active', 'completed');
          if(i < step) pStep.classList.add('completed');
          if(i === step) pStep.classList.add('active');
      }
  }

  window.validateAndNext = function(step) {
      let isValid = true;
      if(step === 1) {
          const name = document.getElementById('input-name');
          const email = document.getElementById('input-email');
          const phone = document.getElementById('input-phone');
          
          if(!name.value.trim()) { isValid=false; name.classList.add('input-error'); }
          if(!email.value.trim()) { isValid=false; email.classList.add('input-error'); }
          if(!phone.value.trim()) { isValid=false; phone.classList.add('input-error'); }
          
          const mode = document.querySelector('input[name="delivery-mode"]:checked').value;
          let locationText = "Pickup";
          if(mode === 'delivery') {
              const addr = document.getElementById('input-address');
              if(!addr.value.trim()) { isValid=false; addr.classList.add('input-error'); }
              else locationText = "Delivery";
          }
          if(isValid) {
              document.getElementById('summary-1').textContent = `${name.value}, ${locationText}`;
              // UNLOCK STEP 2
              maxStepReached = Math.max(maxStepReached, 2);
              document.getElementById('step-2').classList.remove('locked');
              document.getElementById('p-step-2').classList.remove('locked');
              forceGoToStep(2);
          }
      }
      if(step === 2) {
          const date = document.getElementById('input-date');
          const time = document.getElementById('input-time');
          if(!date.value) { isValid=false; date.classList.add('input-error'); }
          if(isValid) {
              document.getElementById('summary-2').textContent = `${date.value} @ ${time.value}`;
              // UNLOCK STEP 3
              maxStepReached = Math.max(maxStepReached, 3);
              document.getElementById('step-3').classList.remove('locked');
              document.getElementById('p-step-3').classList.remove('locked');
              forceGoToStep(3);
          }
      }
      setTimeout(() => document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error')), 500);
  };

  window.toggleDeliveryFields = function() {
      const mode = document.querySelector('input[name="delivery-mode"]:checked').value;
      const addrFields = document.getElementById('address-fields');
      const pickupNote = document.getElementById('pickup-note');
      if(mode === 'delivery') {
          addrFields.style.display = 'block'; pickupNote.style.display = 'none';
          updateTotal(50);
      } else {
          addrFields.style.display = 'none'; pickupNote.style.display = 'flex';
          updateTotal(0);
      }
  };

  function renderCheckoutSummary() {
      const list = document.getElementById('checkout-items-list');
      list.innerHTML = '';
      let subtotal = 0;
      Object.entries(cartState).forEach(([pid, qty]) => {
          if(qty > 0) {
              const product = productsData.find(p => p.id == pid);
              if(!product) return;
              subtotal += product.price * qty;
              const note = cartNotes[pid];
              const noteHTML = note ? `<div style="font-size: 0.8rem; color: #888; margin-top:4px; font-style:italic; font-weight:normal;">"${note}"</div>` : '';

              list.insertAdjacentHTML('beforeend', `
                  <div class="summary-item">
                      <img src="${product.image}" class="s-item-img">
                      <div class="s-item-info">
                          <span class="s-item-name">${product.name}</span>
                          <span class="s-item-meta">Qty: ${qty}</span>
                          ${noteHTML}
                      </div>
                      <span class="s-item-price">₹${(product.price*qty).toFixed(2)}</span>
                  </div>
              `);
          }
      });
      document.getElementById('checkout-total').textContent = `₹${subtotal.toFixed(2)}`;
      document.getElementById('pay-btn-amount').textContent = `₹${subtotal.toFixed(2)}`;
      toggleDeliveryFields(); 
  }

  function updateTotal(fee) {
      let sub = 0;
      Object.entries(cartState).forEach(([pid, qty]) => {
          const p = productsData.find(pd => pd.id == pid);
          if(p) sub += p.price * qty;
      });
      const total = sub + fee;
      document.getElementById('checkout-total').textContent = `₹${total.toFixed(2)}`;
      document.getElementById('checkout-delivery-fee').textContent = `₹${fee.toFixed(2)}`;
      document.getElementById('pay-btn-amount').textContent = `₹${total.toFixed(2)}`;
  }

  const finalPayBtn = document.getElementById('final-pay-btn');
  const successPage = document.getElementById('success-page');
  const continueBtn = document.getElementById('continue-shopping-btn');

  if(finalPayBtn) {
      finalPayBtn.addEventListener('click', () => {
          finalPayBtn.textContent = 'Processing...';
          setTimeout(() => {
              document.getElementById('checkout-page').classList.remove('open');
              if(successPage) successPage.classList.add('open');
              
              const nameVal = document.getElementById('input-name').value || 'Guest';
              const amtVal = document.getElementById('pay-btn-amount').textContent;
              document.getElementById('success-customer-name').textContent = nameVal;
              document.getElementById('success-amount').textContent = amtVal;
              document.getElementById('success-order-id').textContent = Math.floor(1000 + Math.random()*9000);
              
              finalPayBtn.innerHTML = `PAY <span id="pay-btn-amount">₹0.00</span>`;
              for(let k in cartState) delete cartState[k];
              for(let k in cartNotes) delete cartNotes[k];
              syncUI('reset', 0);
              document.querySelectorAll('input').forEach(i => i.value = '');
          }, 1500);
      });
  }
  if(continueBtn) {
      continueBtn.addEventListener('click', () => {
          successPage.classList.remove('open');
          window.scrollTo({ top: 0, behavior: 'smooth' });
      });
  }
</script>