---
import StoreNavbar from "./StoreNavbar.astro";
import StoreHero from "./StoreHero.astro";
import CategoryBar from "./CategoryBar.astro";
import ProductGrid from "./ProductGrid.astro";
import ProductModal from "./ProductModal.astro";
import CartDrawer from "./CartDrawer.astro";
import CheckoutWizard from "./CheckoutWizard.astro";
import StoreFooter from "./StoreFooter.astro";

const {
  store = {},
  theme = {},
  products = [],
  isPreview = false,
  layout = "natural",
  font = "classic",
} = Astro.props;

// 1. Safe Defaults
const safeStore = {
  id: store.id,
  name: store.name || "Your Store Name",
  tagline: store.tagline || "A short soulful tagline",
  about:
    store.about ||
    "Tell customers about your craft, your journey, and what makes you special.",
  logo: store.logo || null,
  address: store.address || null,
  email: store.contact_email,
  whatsapp: store.whatsapp_number,
};

// 2. Color Mapping
const colorStyles = {
  "--theme-brand": theme.primary || "#5b3a1e",
  "--theme-accent": theme.secondary || "#c46a2b",
  "--theme-page": theme.background || "#fffaf0",
  "--theme-ink": theme.text || "#1f1f1f",
  "--theme-header-bg": theme.header || theme.background || "#fffaf0",
};

// 3. Categories (Mock)
const categories = ["All", "Cakes", "Breads", "Cookies", "Hampers"];

// 4. Products
const displayProducts =
  products.length > 0
    ? products
    : [
        {
          id: 1,
          name: "Rustic Sourdough",
          price: 12.0,
          image:
            "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQE9r-lTbqJKsW1nwiQTdVftDfHtIbyqbzyPQ&s",
          description: "Crispy crust with a chewy, airy interior.",
          full_details:
            "Our signature loaf, fermented for 48 hours using wild yeast.",
          product_notice: null,
          accepts_custom_note: false,
        },
        {
          id: 2,
          name: "Rosemary Focaccia",
          price: 14.0,
          image:
            "https://howtofeedaloon.com/wp-content/uploads/2025/04/Focaccia-wtih-Rosemary-and-Olive-Oil-IG.jpg",
          description: "Infused with fresh rosemary and sea salt.",
          full_details: "Baked in olive oil for that perfect golden crunch.",
          product_notice: "Best eaten within 24 hours",
          accepts_custom_note: false,
        },
        {
          id: 3,
          name: "Celebration Cake",
          price: 45.0,
          image:
            "https://images.unsplash.com/photo-1578985545062-69928b1d9587?q=80&w=800&auto=format&fit=crop",
          description: "Vanilla bean sponge with berry compote.",
          full_details:
            "A delicate sponge cake layered with fresh seasonal berries.",
          product_notice: "Requires 48hr advance notice",
          accepts_custom_note: true,
        },
      ];
---

<div
  class="store-template-wrapper"
  data-preview={isPreview}
  style={colorStyles}
  data-font-preset={font}
  data-layout={layout}
  data-products={JSON.stringify(displayProducts)}
  data-store-id={safeStore.id}
>
  <StoreNavbar safeStore={safeStore} />

  <StoreHero safeStore={safeStore} />

  <CategoryBar categories={categories} />

  <ProductGrid displayProducts={displayProducts} />

  <StoreFooter safeStore={safeStore} />

  <ProductModal />

  <CartDrawer />

  <CheckoutWizard safeStore={safeStore} />
</div>

<style is:inline>
  /* =========================================
   CORE VARIABLES & RESET
========================================= */
  .store-template-wrapper {
    --spacing-container: 92%;
    --max-width: 1200px;

    --theme-brand: #5b3a1e;
    --theme-accent: #c46a2b;
    --theme-page: #fffaf0;
    --theme-ink: #1f1f1f;

    --font-display: "Playfair Display", serif;
    --font-heading: "Playfair Display", serif;
    --font-body: "Inter", sans-serif;

    background-color: var(--theme-page);
    color: var(--theme-ink);
    font-family: var(--font-body);
    width: 100%;
    min-height: 100%;
    position: relative;
    overflow-x: hidden;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* FONT PRESETS */
  .store-template-wrapper[data-font-preset="editorial"] {
    --font-display: "Playfair Display", serif;
    --font-heading: "Playfair Display", serif;
    --font-body: "Inter", sans-serif;
  }
  .store-template-wrapper[data-font-preset="editorial"] .store-name {
    font-style: italic;
  }

  .store-template-wrapper[data-font-preset="modernist"] {
    --font-display: "Lexend", sans-serif;
    --font-heading: "Lexend", sans-serif;
    --font-body: "Inter", sans-serif;
  }
  .store-template-wrapper[data-font-preset="modernist"] .store-name {
    text-transform: uppercase;
    letter-spacing: -0.02em;
  }

  .store-template-wrapper[data-font-preset="maker"] {
    --font-display: "Dosis", sans-serif;
    --font-heading: "Dosis", sans-serif;
    --font-body: "Quicksand", sans-serif;
  }

  /* Global Scroll & Helper Styles */
  html {
    scroll-behavior: smooth;
  }
  section[id] {
    scroll-margin-top: 100px;
  }

  /* MINI STEPPER (Used in Cart) */
  .mini-stepper {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.03);
    padding: 4px 8px;
    border-radius: 50px;
  }
  .mini-step-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: var(--theme-ink);
    opacity: 0.6;
    transition: opacity 0.2s;
  }
  .mini-step-btn:hover {
    opacity: 1;
  }
  .mini-step-qty {
    font-weight: 700;
    font-size: 0.9rem;
    min-width: 15px;
    text-align: center;
  }

  /* ERROR STATES */
  .input-error {
    border-color: #ef4444 !important;
    background-color: #fef2f2 !important;
    animation: shake 0.4s ease-in-out;
  }
  @keyframes shake {
    0%,
    100% {
      transform: translateX(0);
    }
    25% {
      transform: translateX(-5px);
    }
    75% {
      transform: translateX(5px);
    }
  }

  .select-wrapper {
    position: relative;
    width: 100%;
  }
  .select-wrapper::after {
    content: "\e5cf";
    font-family: "Material Symbols Rounded";
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    opacity: 0.5;
  }

  .info-box {
    font-size: 0.9rem;
    line-height: 1.5;
  }
</style>

<script is:inline>
  // ==========================================
  // 1. DATA & STATE
  // ==========================================
  const wrapper = document.querySelector(".store-template-wrapper");
  const productsData = wrapper.dataset.products
    ? JSON.parse(wrapper.dataset.products)
    : [];

  const cartState = {}; // { productId: quantity }
  const cartNotes = {}; // { productId: "Custom Note Text" }

  // ==========================================
  // 2. MAIN SYNC FUNCTION (UI UPDATES)
  // ==========================================
  function syncUI(id, qty) {
    // Target both Card Buttons and Modal Buttons
    const wrappers = document.querySelectorAll(
      `[data-id="${id}"] .add-action-wrapper, #modal-add-wrapper[data-id="${id}"]`,
    );

    wrappers.forEach((wrapper) => {
      const bigBtn = wrapper.querySelector(".big-add-btn");
      const stepper = wrapper.querySelector(".stepper-controls");
      const display = wrapper.querySelector(".qty-display");

      if (qty > 0) {
        if (bigBtn) bigBtn.style.display = "none";
        if (stepper) stepper.style.display = "flex";
        if (display) display.textContent = qty;
      } else {
        if (stepper) stepper.style.display = "none";
        if (bigBtn) bigBtn.style.display = "flex";
      }
    });

    // Update Header Badge
    const totalItems = Object.values(cartState).reduce((a, b) => a + b, 0);
    document
      .querySelectorAll(".cart-count")
      .forEach((el) => (el.textContent = totalItems));

    const cartCountNum = document.querySelector(".cart-count-num");
    if (cartCountNum) cartCountNum.textContent = totalItems;

    renderCart(); // Keep drawer updated
  }

  // ==========================================
  // 3. RENDER CART DRAWER
  // ==========================================
  function renderCart() {
    const container = document.querySelector(".cart-items-container");
    const totalPriceEl = document.querySelector(".cart-total-price");
    if (!container) return;

    container.innerHTML = "";
    let total = 0;
    let hasItems = false;

    Object.entries(cartState).forEach(([pid, qty]) => {
      if (qty > 0) {
        hasItems = true;
        const product = productsData.find((p) => p.id == pid);
        if (!product) return;
        total += product.price * qty;

        const itemHTML = `
                <div class="cart-item">
                    <img src="${product.image}" class="cart-item-img" alt="${product.name}">
                    <div class="cart-item-details">
                        <div class="cart-item-top">
                            <h4 class="cart-item-title">${product.name}</h4>
                            <div class="cart-item-variant">Standard</div>
                        </div>
                        <button class="cart-remove-btn" onclick="updateCartItem('${pid}', 0)" title="Remove">
                            <span class="material-symbols-rounded">close</span>
                        </button>
                        <div class="cart-item-bottom">
                            <span class="cart-item-price">₹${(product.price * qty).toFixed(2)}</span>
                            <div class="mini-stepper">
                                <button class="mini-step-btn" onclick="updateCartItem('${pid}', ${qty - 1})">-</button>
                                <span class="mini-step-qty">${qty}</span>
                                <button class="mini-step-btn" onclick="updateCartItem('${pid}', ${qty + 1})">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        container.insertAdjacentHTML("beforeend", itemHTML);
      }
    });

    if (!hasItems)
      container.innerHTML =
        '<div class="cart-empty-state">Your bag is empty</div>';
    if (totalPriceEl) totalPriceEl.textContent = `₹${total.toFixed(2)}`;
  }

  window.updateCartItem = function (pid, newQty) {
    if (newQty < 0) newQty = 0;
    cartState[pid] = newQty;
    syncUI(pid, newQty);
  };

  // ==========================================
  // 4. ADD TO CART LOGIC (CARDS & MODAL)
  // ==========================================
  function attachStepperLogic(wrapper, productId) {
    const bigBtn = wrapper.querySelector(".big-add-btn");
    const plus = wrapper.querySelector(".plus");
    const minus = wrapper.querySelector(".minus");
    if (!bigBtn) return;

    // Clone to strip old listeners
    const newBig = bigBtn.cloneNode(true);
    const newPlus = plus.cloneNode(true);
    const newMinus = minus.cloneNode(true);
    bigBtn.parentNode.replaceChild(newBig, bigBtn);
    plus.parentNode.replaceChild(newPlus, plus);
    minus.parentNode.replaceChild(newMinus, minus);

    // ADD BUTTON CLICK
    newBig.addEventListener("click", (e) => {
      e.stopPropagation();

      // Capture Note if inside Modal
      const noteInput = document.getElementById("custom-note-text");
      const modalWrapper = document.getElementById("modal-add-wrapper");
      if (
        wrapper === modalWrapper &&
        noteInput &&
        noteInput.value.trim() !== ""
      ) {
        cartNotes[productId] = noteInput.value.trim();
        noteInput.value = "";
      }

      cartState[productId] = 1;
      syncUI(productId, 1);
      toggleCart(true);

      // Close modal if open
      const modal = document.getElementById("product-modal");
      if (modal && modal.open) modal.close();
    });

    newPlus.addEventListener("click", (e) => {
      e.stopPropagation();
      cartState[productId] = (cartState[productId] || 0) + 1;
      syncUI(productId, cartState[productId]);
    });
    newMinus.addEventListener("click", (e) => {
      e.stopPropagation();
      cartState[productId] = Math.max(0, (cartState[productId] || 0) - 1);
      syncUI(productId, cartState[productId]);
    });
  }

  // Initialize Product Cards
  document.querySelectorAll(".product-card").forEach((card) => {
    const pid = card.dataset.id;
    const wrapper = card.querySelector(".add-action-wrapper");
    if (wrapper) attachStepperLogic(wrapper, pid);
  });

  // ==========================================
  // 5. MODAL LOGIC
  // ==========================================
  const modal = document.getElementById("product-modal");
  const modalWrapper = document.getElementById("modal-add-wrapper");

  const mImg = document.getElementById("modal-img");
  const mTitle = document.getElementById("modal-title");
  const mPrice = document.getElementById("modal-price");
  const mDesc = document.getElementById("modal-desc");
  const mNotice = document.getElementById("modal-notice-box");
  const mNoticeText = document.getElementById("modal-notice-text");
  const mCustom = document.getElementById("modal-custom-input");
  const mCustomText = document.getElementById("custom-note-text");

  document.querySelectorAll(".product-card").forEach((card) => {
    card.addEventListener("click", (e) => {
      if (e.target.closest(".add-action-wrapper")) return; // Ignore clicks on button

      const data = JSON.parse(card.dataset.product);
      const pid = card.dataset.id;

      // Fill Data
      if (mImg) mImg.src = data.image;
      if (mTitle) mTitle.textContent = data.name;
      if (mPrice) mPrice.textContent = `₹${data.price.toFixed(2)}`;
      if (mDesc) mDesc.textContent = data.full_details || data.description;

      if (data.product_notice) {
        if (mNotice) mNotice.style.display = "flex";
        if (mNoticeText) mNoticeText.textContent = data.product_notice;
      } else {
        if (mNotice) mNotice.style.display = "none";
      }

      // Show Note Field?
      if (data.accepts_custom_note) {
        if (mCustom) mCustom.style.display = "block";
        if (mCustomText) mCustomText.value = cartNotes[pid] || "";
      } else {
        if (mCustom) mCustom.style.display = "none";
        if (mCustomText) mCustomText.value = "";
      }

      if (modalWrapper) {
        modalWrapper.dataset.id = pid;
        attachStepperLogic(modalWrapper, pid);
        syncUI(pid, cartState[pid] || 0); // Update button state
      }
      if (modal) modal.showModal();
    });
  });

  const productModalClose = document.querySelector(".modal-close-btn");
  if (productModalClose)
    productModalClose.addEventListener("click", () => modal.close());
  if (modal)
    modal.addEventListener("click", (e) => {
      if (e.target === modal) modal.close();
    });

  // ==========================================
  // 6. NAVIGATION & DRAWERS
  // ==========================================
  const cartDrawer = document.querySelector(".cart-drawer");
  const cartOverlay = document.querySelector(".cart-overlay");

  function toggleCart(open) {
    if (open) {
      if (cartDrawer) cartDrawer.classList.add("open");
      if (cartOverlay) cartOverlay.classList.add("open");
    } else {
      if (cartDrawer) cartDrawer.classList.remove("open");
      if (cartOverlay) cartOverlay.classList.remove("open");
    }
  }

  const cartBtn = document.querySelector(".cart-btn");
  const cartCloseBtn = document.querySelector(".cart-close-btn");
  if (cartBtn) cartBtn.addEventListener("click", () => toggleCart(true));
  if (cartCloseBtn)
    cartCloseBtn.addEventListener("click", () => toggleCart(false));
  if (cartOverlay)
    cartOverlay.addEventListener("click", () => toggleCart(false));

  // Mobile Menu Logic
  const mobileMenuBtn = document.querySelector(".mobile-menu-btn");
  const mobileMenuCloseBtn = document.querySelector(".mobile-close-btn");
  const mobileMenuOverlay = document.querySelector(".mobile-menu-overlay");

  if (mobileMenuBtn)
    mobileMenuBtn.addEventListener("click", () => {
      mobileMenuOverlay.classList.add("open");
    });

  if (mobileMenuCloseBtn)
    mobileMenuCloseBtn.addEventListener("click", () => {
      mobileMenuOverlay.classList.remove("open");
    });

  if (mobileMenuOverlay)
    mobileMenuOverlay.addEventListener("click", (e) => {
      if (e.target === mobileMenuOverlay)
        mobileMenuOverlay.classList.remove("open");
    });

  // ==========================================
  // CHECKOUT LOGIC (LOCKED WIZARD)
  // ==========================================
  const checkoutTriggerBtn = document.querySelector(".checkout-btn");
  const checkoutPage = document.getElementById("checkout-page");
  const checkoutBackBtn = document.getElementById("close-checkout-btn");

  // TRACKING STEP PROGRESS
  let maxStepReached = 1;

  if (checkoutTriggerBtn) {
    checkoutTriggerBtn.addEventListener("click", () => {
      const totalQty = Object.values(cartState).reduce((a, b) => a + b, 0);
      if (totalQty === 0) {
        alert("Your bag is empty!");
        return;
      }
      toggleCart(false);
      checkoutPage.classList.add("open");
      renderCheckoutSummary();

      // Reset state on open
      maxStepReached = 1;
      document.getElementById("step-2").classList.add("locked");
      document.getElementById("step-3").classList.add("locked");
      document.getElementById("p-step-2").classList.add("locked");
      document.getElementById("p-step-3").classList.add("locked");
      forceGoToStep(1);
    });
  }
  if (checkoutBackBtn) {
    checkoutBackBtn.addEventListener("click", () => {
      checkoutPage.classList.remove("open");
      toggleCart(true);
    });
  }

  // Called when clicking header. Only allows if step is unlocked.
  window.attemptGoToStep = function (step) {
    if (step > maxStepReached) return; // BLOCKED!
    forceGoToStep(step);
  };

  // Internal function to actually move
  function forceGoToStep(step) {
    document.querySelectorAll(".checkout-step").forEach((el) => {
      el.classList.add("collapsed");
      el.classList.remove("active");
    });
    const activeStep = document.getElementById(`step-${step}`);
    if (activeStep) {
      activeStep.classList.remove("collapsed");
      activeStep.classList.add("active");
    }

    // Update Progress Bar
    for (let i = 1; i <= 3; i++) {
      const pStep = document.getElementById(`p-step-${i}`);
      if (pStep) {
        pStep.classList.remove("active", "completed");
        if (i < step) pStep.classList.add("completed");
        if (i === step) pStep.classList.add("active");
      }
    }
  }

  window.validateAndNext = function (step) {
    let isValid = true;
    if (step === 1) {
      const name = document.getElementById("input-name");
      const email = document.getElementById("input-email");
      const phone = document.getElementById("input-phone");

      if (!name.value.trim()) {
        isValid = false;
        name.classList.add("input-error");
      }
      if (!email.value.trim()) {
        isValid = false;
        email.classList.add("input-error");
      }
      if (!phone.value.trim()) {
        isValid = false;
        phone.classList.add("input-error");
      }

      const mode = document.querySelector(
        'input[name="delivery-mode"]:checked',
      ).value;
      let locationText = "Pickup";
      if (mode === "delivery") {
        const addr = document.getElementById("input-address");
        if (!addr.value.trim()) {
          isValid = false;
          addr.classList.add("input-error");
        } else locationText = "Delivery";
      }
      if (isValid) {
        document.getElementById("summary-1").textContent =
          `${name.value}, ${locationText}`;
        // UNLOCK STEP 2
        maxStepReached = Math.max(maxStepReached, 2);
        document.getElementById("step-2").classList.remove("locked");
        document.getElementById("p-step-2").classList.remove("locked");
        forceGoToStep(2);
      }
    }
    if (step === 2) {
      const date = document.getElementById("input-date");
      const time = document.getElementById("input-time");
      if (!date.value) {
        isValid = false;
        date.classList.add("input-error");
      }
      if (isValid) {
        document.getElementById("summary-2").textContent =
          `${date.value} @ ${time.value}`;
        // UNLOCK STEP 3
        maxStepReached = Math.max(maxStepReached, 3);
        document.getElementById("step-3").classList.remove("locked");
        document.getElementById("p-step-3").classList.remove("locked");
        forceGoToStep(3);
      }
    }
    setTimeout(
      () =>
        document
          .querySelectorAll(".input-error")
          .forEach((el) => el.classList.remove("input-error")),
      500,
    );
  };

  window.toggleDeliveryFields = function () {
    const mode = document.querySelector(
      'input[name="delivery-mode"]:checked',
    ).value;
    const addrFields = document.getElementById("address-fields");
    const pickupNote = document.getElementById("pickup-note");
    if (mode === "delivery") {
      if (addrFields) addrFields.style.display = "block";
      if (pickupNote) pickupNote.style.display = "none";
    } else {
      if (addrFields) addrFields.style.display = "none";
      if (pickupNote) pickupNote.style.display = "flex";
    }
    renderCheckoutSummary();
  };

  function renderCheckoutSummary() {
    const list = document.getElementById("checkout-items-list");
    const subtotalEl = document.getElementById("checkout-subtotal");
    const deliveryEl = document.getElementById("checkout-delivery-fee");
    const totalEl = document.getElementById("checkout-total");
    const payBtnAmt = document.getElementById("pay-btn-amount");

    if (!list) return;
    list.innerHTML = "";
    let subtotal = 0;

    Object.entries(cartState).forEach(([pid, qty]) => {
      if (qty > 0) {
        const p = productsData.find((x) => x.id == pid);
        if (!p) return;
        subtotal += p.price * qty;

        list.insertAdjacentHTML(
          "beforeend",
          `
          <div class="summary-item">
            <img src="${p.image}" class="s-item-img">
            <div class="s-item-info">
              <span class="s-item-name">${p.name} (x${qty})</span>
              <span class="s-item-meta">${cartNotes[pid] || "Standard"}</span>
            </div>
            <span class="s-item-price">₹${(p.price * qty).toFixed(2)}</span>
          </div>
        `,
        );
      }
    });

    const mode = document.querySelector(
      'input[name="delivery-mode"]:checked',
    ).value;
    const deliveryFee = mode === "delivery" ? 50 : 0;
    const total = subtotal + deliveryFee;

    if (subtotalEl) subtotalEl.textContent = `₹${subtotal.toFixed(2)}`;
    if (deliveryEl) deliveryEl.textContent = `₹${deliveryFee.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `₹${total.toFixed(2)}`;
    if (payBtnAmt) payBtnAmt.textContent = `₹${total.toFixed(2)}`;
  }

  // FINAL PAY ACTION
  const finalPayBtn = document.getElementById("final-pay-btn");
  if (finalPayBtn) {
    finalPayBtn.addEventListener("click", async () => {
      const paymentMethod = document.querySelector(
        'input[name="payment"]:checked',
      )?.value;

      if (paymentMethod === "online") {
        finalPayBtn.disabled = true;
        const originalText = finalPayBtn.innerHTML;
        finalPayBtn.textContent = "PROCESSING...";

        try {
          const storeId = wrapper.dataset.storeId;
          const items = Object.entries(cartState)
            .filter(([_, qty]) => qty > 0)
            .map(([pid, qty]) => {
              const p = productsData.find((x) => x.id == pid);
              return {
                product_id: pid,
                quantity: qty,
                variant: null,
                custom_note: cartNotes[pid] || null,
              };
            });

          const deliveryMode = document.querySelector(
            'input[name="delivery-mode"]:checked',
          )?.value;

          const payload = {
            store_id: storeId,
            customer: {
              name: document.getElementById("input-name")?.value,
              phone: document.getElementById("input-phone")?.value,
              email: document.getElementById("input-email")?.value,
            },
            delivery: {
              method: deliveryMode,
              address:
                deliveryMode === "delivery"
                  ? document.getElementById("input-address")?.value
                  : null,
              lat: null,
              lng: null,
              date: document.getElementById("input-date")?.value,
              time_slot: document.getElementById("input-time")?.value,
              pincode:
                deliveryMode === "delivery"
                  ? document.getElementById("input-pincode")?.value
                  : null,
            },
            items: items,
            notes: document.getElementById("input-note")?.value || null,
          };

          const res = await fetch(
            "https://flltodzoonathwovcicj.supabase.co/functions/v1/Place-Order",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            },
          );

          const data = await res.json();

          if (!res.ok) {
            throw new Error(
              data?.error || data?.message || "Order creation failed",
            );
          }

          if (data.payment_link_url) {
            window.location.href = data.payment_link_url;
          } else {
            // Fallback if no payment link (shouldn't happen for online)
            alert("Order placed, but no payment link received.");
          }
        } catch (err) {
          alert(
            err.message || "Something went wrong while placing your order.",
          );
          finalPayBtn.disabled = false;
          finalPayBtn.innerHTML = originalText;
        }
      } else {
        // Pay on Pickup logic
        finalPayBtn.disabled = true;
        finalPayBtn.textContent = "PROCESSING...";

        setTimeout(() => {
          // Success!
          const toast = document.getElementById("success-toast");
          if (toast) toast.classList.add("show");

          setTimeout(() => {
            if (toast) toast.classList.remove("show");
            if (checkoutPage) checkoutPage.classList.remove("open");
            // Clear cart
            Object.keys(cartState).forEach((k) => (cartState[k] = 0));
            Object.keys(cartNotes).forEach((k) => delete cartNotes[k]);
            syncUI(null, 0);
            finalPayBtn.disabled = false;
            finalPayBtn.innerHTML = `PAY <span id="pay-btn-amount">₹0.00</span>`;
          }, 3000);
        }, 2000);
      }
    });
  }
</script>
