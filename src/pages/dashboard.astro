---
export const prerender = false;

import { requireAuth, logout } from '../lib/auth';
import { hasStore, getUserStore } from '../lib/stores';
import type { Session } from '@supabase/supabase-js';

// ğŸ” Require authentication
const session = (await requireAuth(Astro)) as Session;

// ğŸª Check if user has a store
const userHasStore = await hasStore();

if (!userHasStore) {
  return Astro.redirect('/create-store');
}

// ğŸ¬ Fetch store (safe because hasStore = true)
const store = await getUserStore();

// ğŸšª Handle logout
if (Astro.request.method === 'POST') {
  return await logout(Astro);
}
---

<h1>You are logged in</h1>
<p>{session.user.email}</p>

<form method="POST">
  <button type="submit">Logout</button>
</form>
