---
export const prerender = false;

import { supabase } from '../lib/supabase';
import { getSession } from '../lib/auth';
import '../styles/auth.css';

// üîÅ Redirect logged-in users
const session = await getSession();
if (session) {
  return Astro.redirect('/dashboard');
}

let error = '';

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();

    const email = formData.get('email')?.toString().trim();
    const password = formData.get('password')?.toString();

    if (!email || !password) {
      error = 'Email and password are required';
    } else {
      const { error: signInError } =
        await supabase.auth.signInWithPassword({ email, password });

      if (signInError) {
        error = signInError.message;
      } else {
        return Astro.redirect('/dashboard');
      }
    }
  } catch {
    error = 'Something went wrong. Please try again.';
  }
}
---

<div class="auth-page">
  <div class="auth-card">
    <div class="auth-form">
      <h1>Panchasara</h1>
      <h2>Welcome back</h2>

      <form method="POST">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Password" required />

        <button type="submit">Log in</button>
      </form>

      {error && <p class="error">{error}</p>}

      <p class="switch">
        Don&#39;t have an account?
        <a href="/signup">Create one</a>
      </p>
    </div>

    <div class="auth-image">
      <img src="/images/login.jpg" alt="Artisan food" />
    </div>
  </div>
</div>
