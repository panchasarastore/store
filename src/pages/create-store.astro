---
export const prerender = false;

import StoreTemplate from '../components/store/StoreTemplate.astro';
import { requireAuth } from '../lib/auth';
import { hasStore } from '../lib/stores';

// ----------------------------------
// Auth + routing guard
// ----------------------------------
await requireAuth(Astro);

if (await hasStore()) {
  return Astro.redirect('/dashboard');
}

// ----------------------------------
// Preview-only placeholder data
// ----------------------------------
const previewStore = {
  name: 'The Sourdough Studio',
  tagline: 'Slow-fermented love from my heart to yours',
  about:
    'Every loaf I bake is a 48-hour labor of love. I began my journey in a small kitchen in Tuscany, learning the ancient art of wild yeast fermentation.',
  logo: '',
};

const previewTheme = {
  primary: '#c46a2b',    // Saffron (Your new Primary)
  secondary: '#7a5c3d',  // Medium Brown (Your new Secondary)
  background: '#fffaf0', // Floral White (Your new Bg)
  text: '#5b3a1e',       // Dark Brown (Your new Text)
};

const previewProducts = [];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Store – Panchasara</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/styles/create-store.css" />
    <link rel="stylesheet" href="/styles/store-template.css" />
  </head>

  <body>
    <div class="create-store-layout">
      <section class="form-panel">
        <div class="form-container">
          <header class="page-header">
            <h1>Create Your Store</h1>
            <p>Set up your artisan storefront</p>
          </header>

          <form class="store-form" method="POST">
            <section class="form-section">
              <h2>Store Basics</h2>

              <label>
                Store Name *
                <input
                  type="text"
                  name="store_name"
                  placeholder="The Sourdough Studio"
                  required
                />
              </label>

              <label>
                Store URL *
                <div class="url-input">
                  <span>panchasara.com/</span>
                  <input
                    type="text"
                    name="store_url_slug"
                    placeholder="sourdough-studio"
                    required
                  />
                </div>
              </label>
            </section>

            <section class="form-section">
              <h2>Brand Voice</h2>

              <label>
                Tagline
                <input
                  type="text"
                  name="store_tagline"
                  placeholder="Slow-fermented love from my kitchen"
                />
              </label>

              <label>
                About the Store
                <textarea
                  name="about_us"
                  rows="5"
                  placeholder="Tell your story…"
                ></textarea>
              </label>
            </section>

            <section class="form-section">
              <h2>Visual Identity – Colors</h2>

              <div class="color-grid">
                <label>
                  Primary
                  <input type="color" name="color_primary" value="#c46a2b" />
                </label>

                <label>
                  Secondary
                  <input type="color" name="color_secondary" value="#7a5c3d" />
                </label>

                <label>
                  Background
                  <input type="color" name="color_background" value="#fffaf0" />
                </label>

                <label>
                  Text
                  <input type="color" name="color_text" value="#5b3a1e" />
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Visual Identity – Fonts</h2>

              <div class="font-options">
                <label>
                  <input type="radio" name="font_preset" value="classic" checked />
                  Playfair Display
                </label>

                <label>
                  <input type="radio" name="font_preset" value="modern" />
                  Poppins
                </label>

                <label>
                  <input type="radio" name="font_preset" value="minimal" />
                  Inter
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Store Layout</h2>

              <div class="template-options">
                <label>
                  <input type="radio" name="template" value="classic" checked />
                  Classic
                </label>

                <label>
                  <input type="radio" name="template" value="minimal" />
                  Minimal
                </label>

                <label>
                  <input type="radio" name="template" value="bold" />
                  Bold
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Logo</h2>

              <label class="file-upload-box">
                <input type="file" name="logo" accept="image/*" />
                
                <div class="upload-icon-wrapper">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                </div>
                <span class="upload-text">Click to upload brand logo</span>
                <span class="upload-hint">SVG, PNG, JPG (Max 2MB)</span>
                
                <img class="logo-preview-thumb" />
              </label>
            </section>

            <section class="form-section">
              <h2>Contact & Social</h2>

              <label>
                Contact Email
                <input type="email" name="contact_email" />
              </label>

              <label>
                WhatsApp Number
                <input type="tel" name="whatsapp_number" placeholder="+91…" />
              </label>

              <label>
                Instagram URL
                <input type="url" name="instagram_url" />
              </label>

              <label>
                Facebook URL
                <input type="url" name="facebook_url" />
              </label>

            </section>

            <footer class="form-actions">
              <button type="button" class="btn-secondary">
                Back
              </button>

              <button type="submit" class="btn-primary">
                Save & Continue
              </button>
            </footer>
          </form>
        </div>
      </section>

      <section class="preview-panel">
        <div class="preview-browser">
          <div class="browser-bar">
            <div class="browser-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <div class="browser-url">
              panchasara.com/sourdough-studio
            </div>
          </div>

          <div class="preview-content">
            <StoreTemplate
              store={previewStore}
              theme={previewTheme}
              products={previewProducts}
              isPreview={true}
            />
          </div>
        </div>
      </section>
    </div>

    <script>
      // 1. Select DOM Elements
      const form = document.querySelector('.store-form');
      const previewContainer = document.querySelector('.preview-content');
      const browserUrl = document.querySelector('.browser-url');

      // 2. State Mapping
      const textMappings = {
        'store_name': '.store-template-name', 
        'store_tagline': '.store-template-tagline',
        'about_us': '.store-template-about',
      };

      const cssVarMappings = {
        'color_primary': '--theme-primary',
        'color_secondary': '--theme-secondary',
        'color_background': '--theme-background',
        'color_text': '--theme-text'
      };

      // 3. Event Listener for Inputs
      form.addEventListener('input', (e) => {
        const input = e.target;
        const name = input.name;
        const val = input.value;

        // --- HANDLE URL UPDATE (The logic you asked for!) ---
        if (name === 'store_url_slug') {
            // Convert "My Store" -> "my-store"
            const slug = val.trim().toLowerCase().replace(/\s+/g, '-');
            // Update the fake browser bar
            if(slug.length > 0) {
                browserUrl.textContent = `panchasara.com/${slug}`; 
            } else {
                browserUrl.textContent = 'panchasara.com/your-store.';
            }
        }

        // --- Handle Standard Text Updates ---
        if (textMappings[name]) {
          const targetEl = previewContainer.querySelector(textMappings[name]);
          if (targetEl) targetEl.textContent = val;
        }

        // --- Handle Color Updates (CSS Vars) ---
        if (cssVarMappings[name]) {
          previewContainer.style.setProperty(cssVarMappings[name], val);
        }
        
        // --- Handle Fonts/Layouts (Classes) ---
        if (name === 'font_preset') {
          previewContainer.setAttribute('data-font-preset', val);
        }
      });

      // 4. Handle Logo Preview (New Box Logic)
      const logoInput = form.querySelector('input[name="logo"]');
      const uploadBox = form.querySelector('.file-upload-box'); 
      const thumb = uploadBox.querySelector('.logo-preview-thumb'); 

      logoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const result = e.target.result;
            
            // A. Update the Big Preview on the Right
            const mainPreviewImg = previewContainer.querySelector('.store-template-logo');
            if (mainPreviewImg) {
                mainPreviewImg.src = result;
                mainPreviewImg.style.display = 'block';
            }

            // B. Update the Tiny Thumbnail in the Form
            if (thumb) {
                thumb.src = result;
                thumb.classList.add('preview-active');
            }
          };
          reader.readAsDataURL(file);
        }
      });
    </script>

    <script>
  // 1. Select the Form and the Preview Container
  const form = document.querySelector('.store-form');
  const previewContainer = document.querySelector('.store-template-wrapper');
  const browserUrl = document.querySelector('.browser-url');

  // 2. Map Form Input Names to CSS Classes in the Template
  const textMappings = {
    'store_name': ['.store-template-name', '.store-template-name-footer'], // Updates header and footer
    'store_tagline': '.store-template-tagline',
    'about_us': '.store-template-about',
  };

  // 3. Map Color Inputs to CSS Variables
  const cssVarMappings = {
    'color_primary': '--theme-primary',
    'color_secondary': '--theme-secondary',
    'color_background': '--theme-background',
    'color_text': '--theme-text'
  };

  // 4. Main Event Listener
  form.addEventListener('input', (e) => {
    const input = e.target;
    const name = input.name;
    const val = input.value;

    // --- A. Handle URL Address Bar Update ---
    if (name === 'store_url_slug') {
      const slug = val.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
      browserUrl.textContent = slug ? `${slug}.panchasara.com` : 'your-store.panchasara.com';
    }

    // --- B. Handle Text Updates ---
    if (textMappings[name]) {
      const selectors = Array.isArray(textMappings[name]) ? textMappings[name] : [textMappings[name]];
      selectors.forEach(selector => {
        const targetEls = document.querySelectorAll(selector);
        targetEls.forEach(el => el.textContent = val);
      });
    }

    // --- C. Handle Color Updates ---
    if (cssVarMappings[name]) {
      // We set the variable on the wrapper so it cascades down
      previewContainer.style.setProperty(cssVarMappings[name], val);
    }
    
    // --- D. Handle Fonts (Data Attribute) ---
    if (name === 'font_preset') {
      previewContainer.setAttribute('data-font-preset', val);
    }
    
    // --- E. Handle Layout (Data Attribute) ---
    if (name === 'template') {
      previewContainer.setAttribute('data-layout', val);
    }
  });

  // 5. Handle Logo Upload (Image Preview)
  const logoInput = form.querySelector('input[name="logo"]');
  
  logoInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target.result;
        
        // Update the Template Logo
        const templateLogos = document.querySelectorAll('.store-template-logo');
        templateLogos.forEach(img => {
          img.src = result;
          img.style.display = 'block';
        });

        // Update the Form Thumbnail (The little box in the upload area)
        const formThumb = document.querySelector('.logo-preview-thumb');
        if (formThumb) {
            formThumb.src = result;
            formThumb.classList.add('preview-active');
        }
      };
      reader.readAsDataURL(file);
    }
  });
</script>

  </body>
</html>