---
export const prerender = false;

import StoreTemplate from '../components/store/StoreTemplate.astro';
import { requireAuth } from '../lib/auth';
import { hasStore } from '../lib/stores';

// ----------------------------------
// Auth + routing guard
// ----------------------------------
await requireAuth(Astro);

if (await hasStore()) {
  return Astro.redirect('/dashboard');
}

// ----------------------------------
// Preview-only placeholder data
// ----------------------------------
const previewStore = {
  name: 'The Sourdough Studio',
  tagline: 'Slow-fermented love from my heart to yours',
  about:
    'Every loaf I bake is a 48-hour labor of love. I began my journey in a small kitchen in Tuscany, learning the ancient art of wild yeast fermentation.',
  logo: '',
  contact_email: 'hello@panchasara.com',
  whatsapp_number: '+91 98765 43210'
};

const previewTheme = {
  primary: '#5b3a1e',    // Brand (Dark Brown)
  secondary: '#c46a2b',  // Buttons (Saffron)
  background: '#fffaf0', // Page (Floral White)
  text: '#1f1f1f',       // Ink (Almost Black)
};

const previewProducts = [];
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Store – Panchasara</title>

    <link
      href="[https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap](https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap)"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/styles/create-store.css" />
    <link rel="stylesheet" href="/styles/store-template.css" />
  </head>

  <body>
    <div class="create-store-layout">
      
      <button id="mobile-view-toggle" class="mobile-toggle-btn">
        <span class="show-preview-text">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
           View Preview
        </span>
        <span class="show-editor-text" style="display: none;">
           <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
           Back to Editor
        </span>
      </button>

      <section class="form-panel">
        <div class="form-container">
          <header class="page-header">
            <h1>Create Your Store</h1>
            <p>Set up your artisan storefront</p>
          </header>

          <form class="store-form" method="POST">
            <section class="form-section">
              <h2>Store Basics</h2>

              <label>
                Store Name *
                <input
                  type="text"
                  name="store_name"
                  placeholder="The Sourdough Studio"
                  required
                />
              </label>

              <label>
                Store URL *
                <div class="url-input">
                  <span>panchasara.com/</span>
                  <input
                    type="text"
                    name="store_url_slug"
                    placeholder="sourdough-studio"
                    required
                  />
                </div>
              </label>
            </section>

            <section class="form-section">
              <h2>Brand Voice</h2>

              <label>
                Tagline
                <input
                  type="text"
                  name="store_tagline"
                  placeholder="Slow-fermented love from my kitchen"
                />
              </label>

              <label>
                About the Store
                <textarea
                  name="about_us"
                  rows="5"
                  placeholder="Tell your story…"
                ></textarea>
              </label>
            </section>

            <section class="form-section">
              <h2>Visual Identity – Colors</h2>

              <div class="color-grid">
                <label>
                  Brand Color
                  <span class="input-hint">Store Name & Logos</span>
                  <input type="color" name="color_primary" value="#5b3a1e" />
                </label>

                <label>
                  Buttons Color
                  <span class="input-hint">Buttons & Highlights</span>
                  <input type="color" name="color_secondary" value="#c46a2b" />
                </label>

                <label>
                  Background Color
                  <span class="input-hint">Page Background</span>
                  <input type="color" name="color_background" value="#fffaf0" />
                </label>

                <label>
                  Text Color
                  <span class="input-hint">Paragraphs & Links</span>
                  <input type="color" name="color_text" value="#1f1f1f" />
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Visual Identity – Fonts</h2>

              <div class="font-options">
                <label>
                  <input type="radio" name="font_preset" value="classic" checked />
                  Playfair Display
                </label>

                <label>
                  <input type="radio" name="font_preset" value="modern" />
                  Poppins
                </label>

                <label>
                  <input type="radio" name="font_preset" value="minimal" />
                  Inter
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Store Layout</h2>

              <div class="template-options">
                <label>
                  <input type="radio" name="template" value="classic" checked />
                  Classic
                </label>

                <label>
                  <input type="radio" name="template" value="minimal" />
                  Minimal
                </label>

                <label>
                  <input type="radio" name="template" value="bold" />
                  Bold
                </label>
              </div>
            </section>

            <section class="form-section">
              <h2>Logo</h2>

              <label class="file-upload-box">
                <input type="file" name="logo" accept="image/*" />
                
                <div class="upload-icon-wrapper">
                  <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                </div>
                <span class="upload-text">Click to upload brand logo</span>
                <span class="upload-hint">SVG, PNG, JPG (Max 2MB)</span>
                
                <img class="logo-preview-thumb" />
              </label>
            </section>

            <section class="form-section">
              <h2>Contact & Social</h2>

              <div class="input-group">
                <div class="input-group-header">
                    <span class="input-label">Contact Email</span>
                    <label class="toggle-switch">
                        <input type="checkbox" name="show_email" checked />
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="email" name="contact_email" placeholder="hello@panchasara.com" />
              </div>

              <div class="input-group">
                <div class="input-group-header">
                    <span class="input-label">WhatsApp Number</span>
                    <label class="toggle-switch">
                        <input type="checkbox" name="show_whatsapp" checked />
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="tel" name="whatsapp_number" placeholder="+91 98765 43210" />
              </div>

              <div class="input-group">
                <div class="input-group-header">
                    <span class="input-label">Instagram URL</span>
                    <label class="toggle-switch">
                        <input type="checkbox" name="show_instagram" checked />
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="url" name="instagram_url" placeholder="https://instagram.com" />
              </div>

              <div class="input-group">
                <div class="input-group-header">
                    <span class="input-label">Facebook URL</span>
                    <label class="toggle-switch">
                        <input type="checkbox" name="show_facebook" />
                        <span class="slider"></span>
                    </label>
                </div>
                <input type="url" name="facebook_url" placeholder="https://facebook.com" />
              </div>
            </section>

            <footer class="form-actions">
              <button type="button" class="btn-secondary">
                Back
              </button>

              <button type="submit" class="btn-primary">
                Save & Continue
              </button>
            </footer>
          </form>
        </div>
      </section>

      <section class="preview-panel">
        <div class="preview-browser">
          <div class="browser-bar">
            <div class="browser-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <div class="browser-url">
              panchasara.com/sourdough-studio
            </div>
          </div>

          <div class="preview-content">
            <StoreTemplate
              store={previewStore}
              theme={previewTheme}
              products={previewProducts}
              isPreview={true}
            />
          </div>
        </div>
      </section>
    </div>

    <script>
      // 1. Select DOM Elements
      const form = document.querySelector('.store-form');
      const previewContainer = document.querySelector('.store-template-wrapper');
      const browserUrl = document.querySelector('.browser-url');

      // 2. State Mapping
      const textMappings = {
        'store_name': ['.store-template-name', '.store-template-name-footer'], 
        'store_tagline': '.store-template-tagline',
        'about_us': '.store-template-about',
        'contact_email': '.footer-email-text',
        'whatsapp_number': '.footer-whatsapp-text'
      };

      // 3. Attribute Mappings (Value -> CSS Var)
      const cssVarMappings = {
        'color_primary': '--theme-brand',   // Brand
        'color_secondary': '--theme-accent', // Buttons
        'color_background': '--theme-page',  // Background
        'color_text': '--theme-ink'          // Text
      };

      // Helper: Toggle Visibility
      const toggleVisibility = (selector, isVisible) => {
        const el = document.querySelector(selector);
        if (el) el.style.display = isVisible ? 'flex' : 'none';
      };

      // 4. Input Listener
      form.addEventListener('input', (e) => {
        const input = e.target;
        const name = input.name;
        const val = input.value;
        const isChecked = input.checked;

        // --- HANDLE TOGGLES ---
        if (name === 'show_email') toggleVisibility('.footer-email-link', isChecked);
        if (name === 'show_whatsapp') toggleVisibility('.footer-whatsapp-link', isChecked);
        if (name === 'show_instagram') toggleVisibility('.footer-insta-link', isChecked);
        if (name === 'show_facebook') toggleVisibility('.footer-fb-link', isChecked);

        // --- HANDLE URL ---
        if (name === 'store_url_slug') {
            const slug = val.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
            browserUrl.textContent = slug ? `panchasara.com/${slug}` : '[panchasara.com/your-store](https://panchasara.com/your-store)';
        }

        // --- HANDLE TEXT UPDATES ---
        if (textMappings[name]) {
          const selectors = Array.isArray(textMappings[name]) ? textMappings[name] : [textMappings[name]];
          selectors.forEach(selector => {
            const targetEls = document.querySelectorAll(selector);
            targetEls.forEach(el => el.textContent = val);
          });

          // Special Link Updates
          if (name === 'contact_email') {
            const el = document.querySelector('.footer-email-link');
            if (el) el.href = `mailto:${val}`;
          }
          if (name === 'whatsapp_number') {
            const el = document.querySelector('.footer-whatsapp-link');
            if (el) el.href = `https://wa.me/${val.replace(/[^0-9]/g, '')}`;
          }
        }

        // --- HANDLE SOCIAL LINKS ---
        if (name === 'instagram_url') {
            const el = document.querySelector('.footer-insta-link');
            if (el) el.href = val;
        }
        if (name === 'facebook_url') {
            const el = document.querySelector('.footer-fb-link');
            if (el) el.href = val;
        }

        // --- HANDLE COLORS ---
        if (cssVarMappings[name]) {
          previewContainer.style.setProperty(cssVarMappings[name], val);
        }
        
        // --- HANDLE SETTINGS ---
        if (name === 'font_preset') previewContainer.setAttribute('data-font-preset', val);
        if (name === 'template') previewContainer.setAttribute('data-layout', val);
      });

      // 5. Handle Logo Upload
      const logoInput = form.querySelector('input[name="logo"]');
      const uploadBox = form.querySelector('.file-upload-box'); 
      const thumb = uploadBox.querySelector('.logo-preview-thumb'); 

      logoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (e) => {
            const result = e.target.result;
            
            // Update Store Template
            const templateLogos = document.querySelectorAll('.store-template-logo');
            templateLogos.forEach(img => {
              img.src = result;
              img.style.display = 'block';
            });
            
            // Hide Monogram
            const initials = document.querySelectorAll('.store-logo-initial');
            initials.forEach(el => el.style.display = 'none');

            // Update Form Thumbnail
            if (thumb) {
                thumb.src = result;
                thumb.classList.add('preview-active');
            }
          };
          reader.readAsDataURL(file);
        }
      });

      // 6. Mobile View Switcher Logic
      const mobileToggleBtn = document.getElementById('mobile-view-toggle');
      const layoutContainer = document.querySelector('.create-store-layout');
      const previewText = mobileToggleBtn.querySelector('.show-preview-text');
      const editorText = mobileToggleBtn.querySelector('.show-editor-text');

      mobileToggleBtn.addEventListener('click', () => {
        layoutContainer.classList.toggle('mobile-preview-active');
        
        const isPreviewing = layoutContainer.classList.contains('mobile-preview-active');
        if (isPreviewing) {
            previewText.style.display = 'none';
            editorText.style.display = 'flex';
        } else {
            previewText.style.display = 'flex';
            editorText.style.display = 'none';
        }
      });
    </script>
  </body>
</html>